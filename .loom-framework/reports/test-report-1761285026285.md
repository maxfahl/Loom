# Loom Framework Test Report

**Generated**: 2025-10-24T05:50:26.284Z
**Duration**: 7.90s
**Total Suites**: 4
**Passed**: 1
**Failed**: 3

## Test Suites

### ❌ Unit Tests

**Status**: failed

**Error**:
```
Command failed: npm run test:unit --  --passWithNoTests
ts-jest[ts-jest-transformer] (WARN) Define `ts-jest` config under `globals` is deprecated. Please do
transform: {
    <transform_regex>: ['ts-jest', { /* ts-jest config goes here in Jest */ }],
},
See more at https://kulshekhar.github.io/ts-jest/docs/getting-started/presets#advanced
ts-jest[ts-jest-transformer] (WARN) Define `ts-jest` config under `globals` is deprecated. Please do
transform: {
    <transform_regex>: ['ts-jest', { /* ts-jest config goes here in Jest */ }],
},
See more at https://kulshekhar.github.io/ts-jest/docs/getting-started/presets#advanced
ts-jest[ts-jest-transformer] (WARN) Define `ts-jest` config under `globals` is deprecated. Please do
transform: {
    <transform_regex>: ['ts-jest', { /* ts-jest config goes here in Jest */ }],
},
See more at https://kulshekhar.github.io/ts-jest/docs/getting-started/presets#advanced
ts-jest[ts-jest-transformer] (WARN) Define `ts-jest` config under `globals` is deprecated. Please do
transform: {
    <transform_regex>: ['ts-jest', { /* ts-jest config goes here in Jest */ }],
},
See more at https://kulshekhar.github.io/ts-jest/docs/getting-started/presets#advanced
ts-jest[ts-jest-transformer] (WARN) Define `ts-jest` config under `globals` is deprecated. Please do
transform: {
    <transform_regex>: ['ts-jest', { /* ts-jest config goes here in Jest */ }],
},
See more at https://kulshekhar.github.io/ts-jest/docs/getting-started/presets#advanced
ts-jest[ts-jest-transformer] (WARN) Define `ts-jest` config under `globals` is deprecated. Please do
transform: {
    <transform_regex>: ['ts-jest', { /* ts-jest config goes here in Jest */ }],
},
See more at https://kulshekhar.github.io/ts-jest/docs/getting-started/presets#advanced
ts-jest[ts-jest-transformer] (WARN) Define `ts-jest` config under `globals` is deprecated. Please do
transform: {
    <transform_regex>: ['ts-jest', { /* ts-jest config goes here in Jest */ }],
},
See more at https://kulshekhar.github.io/ts-jest/docs/getting-started/presets#advanced
PASS aml/__tests__/security/access-control.test.ts
  AccessControl
    Role-Based Permissions
      ✓ should allow admin all operations (16 ms)
      ✓ should allow developer read/write but not admin operations (3 ms)
      ✓ should allow read-only only read operations (1 ms)
    Agent Isolation
      ✓ should prevent agents from accessing other agents' data (1 ms)
      ✓ should allow agents to access their own data
      ✓ should allow admin to access any agent data (1 ms)
    Project Isolation
      ✓ should prevent access across projects
      ✓ should allow access within same project (1 ms)
      ✓ should allow admin to access any project
    Resource Ownership
      ✓ should prevent non-owners from deleting resources (1 ms)
      ✓ should allow owners to delete their resources
      ✓ should allow admin to delete any resource
    Require Access (Throws)
      ✓ should throw AccessDeniedError when access denied (36 ms)
      ✓ should not throw when access allowed (3 ms)
    Role Hierarchy
      ✓ should recognize admin as higher than developer (1 ms)
      ✓ should recognize developer as higher than read-only (1 ms)
      ✓ should recognize read-only as lowest role (1 ms)
    Permission Checks
      ✓ should check if user can perform ANY operation
      ✓ should check if user can perform ALL operations
    Encryption Context Generation
      ✓ should generate deterministic project context
      ✓ should generate deterministic agent context (1 ms)
    Role Permissions
      ✓ should return all permissions for a role
    Principal Creation
      ✓ should create principal from parameters
      ✓ should parse role strings correctly (1 ms)
      ✓ should default to developer for unknown roles
      ✓ should use environment variables as fallback

FAIL aml/__tests__/BackupManager.test.ts
  BackupManager
    Full Backup
      ✕ should create full backup (5 ms)
      ✕ should include all agent directories in backup (2 ms)
      ✕ should include global data in backup (2 ms)
      ✕ should create compressed backup file (1 ms)
    Incremental Backup
      ✕ should create incremental backup after full backup (2 ms)
      ✕ should be smaller than full backup (2 ms)
    Backup Validation
      ✕ should validate backup integrity (7 ms)
      ✕ should detect corrupted backup (1 ms)
      ✕ should validate backup contents (2 ms)
    Restore Operations
      ✕ should restore from full backup (1 ms)
      ✕ should restore to point in time (1 ms)
      ✕ should create backup before restore (2 ms)
    Backup Cleanup
      ✕ should list all backups (1 ms)
      ✕ should delete old backups (1 ms)
      ✕ should keep last N backups (1 ms)
      ✕ should delete specific backup (1 ms)
    Performance
      ✕ should handle large backup efficiently (1 ms)
      ✕ should restore quickly (1 ms)
    Error Handling
      ✕ should handle missing backup file (1 ms)
      ✕ should handle corrupted backup during restore (14 ms)
      ✕ should handle disk space issues gracefully (6 ms)

  ● BackupManager › Full Backup › should create full backup

    TypeError: memoryStore.ensureAgentDirectory is not a function

      43 |     it('should create full backup', async () => {
      44 |       // Create some test data
    > 45 |       await memoryStore.ensureAgentDirectory('test-agent');
         |                         ^
      46 |       await memoryStore.addPattern('test-agent', {
      47 |         id: 'p1',
      48 |         agent: 'test-agent',

      at Object.<anonymous> (aml/__tests__/BackupManager.test.ts:45:25)

  ● BackupManager › Full Backup › should include all agent directories in backup

    TypeError: memoryStore.ensureAgentDirectory is not a function

      68 |
      69 |     it('should include all agent directories in backup', async () => {
    > 70 |       await memoryStore.ensureAgentDirectory('agent-1');
         |                         ^
      71 |       await memoryStore.ensureAgentDirectory('agent-2');
      72 |       await memoryStore.ensureAgentDirectory('agent-3');
      73 |

      at Object.<anonymous> (aml/__tests__/BackupManager.test.ts:70:25)

  ● BackupManager › Full Backup › should include global data in backup

    TypeError: memoryStore.setGlobalData is not a function

      82 |
      83 |     it('should include global data in backup', async () => {
    > 84 |       await memoryStore.setGlobalData('test-key', { value: 'test' });
         |                         ^
      85 |
      86 |       const result = await backupManager.createFullBackup();
      87 |

      at Object.<anonymous> (aml/__tests__/BackupManager.test.ts:84:25)

  ● BackupManager › Full Backup › should create compressed backup file

    TypeError: memoryStore.ensureAgentDirectory is not a function

      92 |     it('should create compressed backup file', async () => {
      93 |       // Create substantial data
    > 94 |       await memoryStore.ensureAgentDirectory('agent-1');
         |                         ^
      95 |       for (let i = 0; i < 100; i++) {
      96 |         await memoryStore.addPattern('agent-1', {
      97 |           id: `p${i}`,

      at Object.<anonymous> (aml/__tests__/BackupManager.test.ts:94:25)

  ● BackupManager › Incremental Backup › should create incremental backup after full backup

    TypeError: memoryStore.ensureAgentDirectory is not a function

      119 |     it('should create incremental backup after full backup', async () => {
      120 |       // Create full backup
    > 121 |       await memoryStore.ensureAgentDirectory('agent-1');
          |                         ^
      122 |       const fullBackup = await backupManager.createFullBackup();
      123 |
      124 |       // Add more data

      at Object.<anonymous> (aml/__tests__/BackupManager.test.ts:121:25)

  ● BackupManager › Incremental Backup › should be smaller than full backup

    TypeError: memoryStore.ensureAgentDirectory is not a function

      147 |     it('should be smaller than full backup', async () => {
      148 |       // Create base data
    > 149 |       await memoryStore.ensureAgentDirectory('agent-1');
          |                         ^
      150 |       for (let i = 0; i < 50; i++) {
      151 |         await memoryStore.addPattern('agent-1', {
      152 |           id: `p${i}`,

      at Object.<anonymous> (aml/__tests__/BackupManager.test.ts:149:25)

  ● BackupManager › Backup Validation › should validate backup integrity

    TypeError: memoryStore.ensureAgentDirectory is not a function

      191 |   describe('Backup Validation', () => {
      192 |     it('should validate backup integrity', async () => {
    > 193 |       await memoryStore.ensureAgentDirectory('agent-1');
          |                         ^
      194 |       const backup = await backupManager.createFullBackup();
      195 |
      196 |       const validation = await backupManager.validateBackup(backup.data!.backupId);

      at Object.<anonymous> (aml/__tests__/BackupManager.test.ts:193:25)

  ● BackupManager › Backup Validation › should detect corrupted backup

    TypeError: memoryStore.ensureAgentDirectory is not a function

      202 |
      203 |     it('should detect corrupted backup', async () => {
    > 204 |       await memoryStore.ensureAgentDirectory('agent-1');
          |                         ^
      205 |       const backup = await backupManager.createFullBackup();
      206 |
      207 |       // Corrupt the backup file

      at Object.<anonymous> (aml/__tests__/BackupManager.test.ts:204:25)

  ● BackupManager › Backup Validation › should validate backup contents

    TypeError: memoryStore.ensureAgentDirectory is not a function

      216 |
      217 |     it('should validate backup contents', async () => {
    > 218 |       await memoryStore.ensureAgentDirectory('agent-1');
          |                         ^
      219 |       await memoryStore.addPattern('agent-1', {
      220 |         id: 'p1',
      221 |         agent: 'agent-1',

      at Object.<anonymous> (aml/__tests__/BackupManager.test.ts:218:25)

  ● BackupManager › Restore Operations › should restore from full backup

    TypeError: memoryStore.ensureAgentDirectory is not a function

      242 |     it('should restore from full backup', async () => {
      243 |       // Create original data
    > 244 |       await memoryStore.ensureAgentDirectory('agent-1');
          |                         ^
      245 |       await memoryStore.addPattern('agent-1', {
      246 |         id: 'original',
      247 |         agent: 'agent-1',

      at Object.<anonymous> (aml/__tests__/BackupManager.test.ts:244:25)

  ● BackupManager › Restore Operations › should restore to point in time

    TypeError: memoryStore.ensureAgentDirectory is not a function

      276 |
      277 |     it('should restore to point in time', async () => {
    > 278 |       await memoryStore.ensureAgentDirectory('agent-1');
          |                         ^
      279 |
      280 |       // State 1
      281 |       await memoryStore.addPattern('agent-1', {

      at Object.<anonymous> (aml/__tests__/BackupManager.test.ts:278:25)

  ● BackupManager › Restore Operations › should create backup before restore

    TypeError: memoryStore.ensureAgentDirectory is not a function

      322 |
      323 |     it('should create backup before restore', async () => {
    > 324 |       await memoryStore.ensureAgentDirectory('agent-1');
          |                         ^
      325 |       const originalBackup = await backupManager.createFullBackup();
      326 |
      327 |       // Modify data

      at Object.<anonymous> (aml/__tests__/BackupManager.test.ts:324:25)

  ● BackupManager › Backup Cleanup › should list all backups

    TypeError: memoryStore.ensureAgentDirectory is not a function

      359 |   describe('Backup Cleanup', () => {
      360 |     it('should list all backups', async () => {
    > 361 |       await memoryStore.ensureAgentDirectory('agent-1');
          |                         ^
      362 |
      363 |       await backupManager.createFullBackup();
      364 |       await backupManager.createFullBackup();

      at Object.<anonymous> (aml/__tests__/BackupManager.test.ts:361:25)

  ● BackupManager › Backup Cleanup › should delete old backups

    TypeError: memoryStore.ensureAgentDirectory is not a function

      372 |
      373 |     it('should delete old backups', async () => {
    > 374 |       await memoryStore.ensureAgentDirectory('agent-1');
          |                         ^
      375 |
      376 |       // Create multiple backups
      377 |       const backup1 = await backupManager.createFullBackup();

      at Object.<anonymous> (aml/__tests__/BackupManager.test.ts:374:25)

  ● BackupManager › Backup Cleanup › should keep last N backups

    TypeError: memoryStore.ensureAgentDirectory is not a function

      396 |
      397 |     it('should keep last N backups', async () => {
    > 398 |       await memoryStore.ensureAgentDirectory('agent-1');
          |                         ^
      399 |
      400 |       // Create 10 backups
      401 |       for (let i = 0; i < 10; i++) {

      at Object.<anonymous> (aml/__tests__/BackupManager.test.ts:398:25)

  ● BackupManager › Backup Cleanup › should delete specific backup

    TypeError: memoryStore.ensureAgentDirectory is not a function

      415 |
      416 |     it('should delete specific backup', async () => {
    > 417 |       await memoryStore.ensureAgentDirectory('agent-1');
          |                         ^
      418 |
      419 |       const backup = await backupManager.createFullBackup();
      420 |

      at Object.<anonymous> (aml/__tests__/BackupManager.test.ts:417:25)

  ● BackupManager › Performance › should handle large backup efficiently

    TypeError: memoryStore.ensureAgentDirectory is not a function

      431 |     it('should handle large backup efficiently', async () => {
      432 |       // Create substantial data
    > 433 |       await memoryStore.ensureAgentDirectory('agent-1');
          |                         ^
      434 |       for (let i = 0; i < 500; i++) {
      435 |         await memoryStore.addPattern('agent-1', {
      436 |           id: `p${i}`,

      at Object.<anonymous> (aml/__tests__/BackupManager.test.ts:433:25)

  ● BackupManager › Performance › should restore quickly

    TypeError: memoryStore.ensureAgentDirectory is not a function

      458 |
      459 |     it('should restore quickly', async () => {
    > 460 |       await memoryStore.ensureAgentDirectory('agent-1');
          |                         ^
      461 |       for (let i = 0; i < 100; i++) {
      462 |         await memoryStore.addPattern('agent-1', {
      463 |           id: `p${i}`,

      at Object.<anonymous> (aml/__tests__/BackupManager.test.ts:460:25)

  ● BackupManager › Error Handling › should handle missing backup file

    TypeError: backupManager.restore is not a function

      489 |   describe('Error Handling', () => {
      490 |     it('should handle missing backup file', async () => {
    > 491 |       const restoreResult = await backupManager.restore('nonexistent-backup-id');
          |                                                 ^
      492 |
      493 |       expect(restoreResult.success).toBe(false);
      494 |       expect(restoreResult.error).toContain('not found');

      at Object.<anonymous> (aml/__tests__/BackupManager.test.ts:491:49)

  ● BackupManager › Error Handling › should handle corrupted backup during restore

    TypeError: memoryStore.ensureAgentDirectory is not a function

      496 |
      497 |     it('should handle corrupted backup during restore', async () => {
    > 498 |       await memoryStore.ensureAgentDirectory('agent-1');
          |                         ^
      499 |       const backup = await backupManager.createFullBackup();
      500 |
      501 |       // Corrupt backup

      at Object.<anonymous> (aml/__tests__/BackupManager.test.ts:498:25)

  ● BackupManager › Error Handling › should handle disk space issues gracefully

    expect(received).toHaveProperty(path)

    Expected path: "createFullBackup"
    Received path: []

    Received value: {"backupPath": "/Users/maxfahl/Fahl/Common/Loom/.loom-framework/aml/__test_data__/backup-manager/backups", "backups": Map {}, "schedule": null, "store": {"storage": {"basePath": "/Users/maxfahl/Fahl/Common/Loom/.loom-framework/aml/__test_data__/backup-manager/memory", "options": {"compression": true, "encoding": "utf-8", "lockRetries": 5, "lockTimeout": 5000}}}}

      511 |       // This is difficult to test without actually filling disk
      512 |       // We'll just verify error handling structure exists
    > 513 |       expect(backupManager).toHaveProperty('createFullBackup');
          |                             ^
      514 |     });
      515 |   });
      516 | });

      at Object.<anonymous> (aml/__tests__/BackupManager.test.ts:513:29)

FAIL aml/__tests__/QueryEngine.test.ts
  QueryEngine
    Index Management
      ✕ should build pattern index (6 ms)
      ✓ should index patterns by type (1 ms)
      ✓ should index patterns by tags (1 ms)
      ✓ should index patterns by context (3 ms)
      ✓ should index patterns by confidence buckets (5 ms)
      ✓ should build solution index (2 ms)
      ✓ should clear indices (12 ms)
      ✓ should clear agent-specific indices (2 ms)
    Pattern Search
      ✓ should search patterns by type using index (15 ms)
      ✓ should handle non-existent agent in search (2 ms)
      ✓ should search patterns by single context key-value
      ✓ should search patterns by multiple context keys (intersection) (1 ms)
    Similarity Calculation
      ✓ should calculate exact pattern similarity
      ✕ should calculate different pattern similarity (1 ms)
      ✓ should find similar patterns with threshold (1 ms)
      ✓ should exclude self from similarity results
      ✓ should respect similarity threshold (1 ms)
      ✓ should respect limit on results (1 ms)
    Ranking Algorithms
      ✕ should rank patterns by confidence (2 ms)
      ✕ should rank patterns by recency
      ✕ should rank patterns by usage frequency
      ✕ should rank patterns with target context (4 ms)
      ✓ should rank solutions
      ✕ should rank decisions (1 ms)
    Fuzzy Search
      ✓ should fuzzy search patterns by query (1 ms)
      ✓ should find exact substring matches first (1 ms)
      ✓ should fuzzy search solutions by error message
      ✓ should handle case-insensitive fuzzy search
      ✓ should respect minimum similarity threshold in fuzzy search (1 ms)
    Analytics
      ✓ should calculate pattern statistics (2 ms)
      ✓ should identify top pattern types
      ✓ should handle empty pattern list in statistics (1 ms)
    Edge Cases & Performance
      ✓ should handle large pattern sets (7 ms)
      ✓ should handle empty context matching
      ✓ should handle patterns with no tags (1 ms)
      ✓ should handle similarity calculation with different feature spaces (2 ms)

  ● QueryEngine › Index Management › should build pattern index

    expect(received).toBeGreaterThan(expected)

    Expected: > 0
    Received:   0

      26 |       // Verify index was created
      27 |       const results = engine.searchPatternsByType(testAgent, 'react-optimization');
    > 28 |       expect(results.length).toBeGreaterThan(0);
         |                              ^
      29 |     });
      30 |
      31 |     it('should index patterns by type', () => {

      at Object.<anonymous> (aml/__tests__/QueryEngine.test.ts:28:30)

  ● QueryEngine › Similarity Calculation › should calculate different pattern similarity

    expect(received).toBeLessThan(expected)

    Expected: < 0.5
    Received:   0.5000000000000001

      186 |
      187 |       expect(similarity).toBeGreaterThanOrEqual(0);
    > 188 |       expect(similarity).toBeLessThan(0.5);
          |                          ^
      189 |     });
      190 |
      191 |     it('should find similar patterns with threshold', () => {

      at Object.<anonymous> (aml/__tests__/QueryEngine.test.ts:188:26)

  ● QueryEngine › Ranking Algorithms › should rank patterns by confidence

    ZodError: [
      {
        "validation": "uuid",
        "code": "invalid_string",
        "message": "Invalid uuid",
        "path": [
          "id"
        ]
      }
    ]

      69 |
      70 |   constructor(data: Pattern) {
    > 71 |     this.data = PatternSchema.parse(data);
         |                               ^
      72 |   }
      73 |
      74 |   get id(): PatternId {

      at Object.get error [as error] (node_modules/zod/v3/types.cjs:45:31)
      at ZodObject.parse (node_modules/zod/v3/types.cjs:120:22)
      at new PatternModel (aml/models/Pattern.ts:71:31)
      at aml/QueryEngine.ts:329:22
          at Array.map (<anonymous>)
      at QueryEngine.rankPatterns (aml/QueryEngine.ts:328:29)
      at Object.<anonymous> (aml/__tests__/QueryEngine.test.ts:249:29)

  ● QueryEngine › Ranking Algorithms › should rank patterns by recency

    ZodError: [
      {
        "validation": "uuid",
        "code": "invalid_string",
        "message": "Invalid uuid",
        "path": [
          "id"
        ]
      }
    ]

      69 |
      70 |   constructor(data: Pattern) {
    > 71 |     this.data = PatternSchema.parse(data);
         |                               ^
      72 |   }
      73 |
      74 |   get id(): PatternId {

      at Object.get error [as error] (node_modules/zod/v3/types.cjs:45:31)
      at ZodObject.parse (node_modules/zod/v3/types.cjs:120:22)
      at new PatternModel (aml/models/Pattern.ts:71:31)
      at aml/QueryEngine.ts:329:22
          at Array.map (<anonymous>)
      at QueryEngine.rankPatterns (aml/QueryEngine.ts:328:29)
      at Object.<anonymous> (aml/__tests__/QueryEngine.test.ts:270:29)

  ● QueryEngine › Ranking Algorithms › should rank patterns by usage frequency

    ZodError: [
      {
        "validation": "uuid",
        "code": "invalid_string",
        "message": "Invalid uuid",
        "path": [
          "id"
        ]
      }
    ]

      69 |
      70 |   constructor(data: Pattern) {
    > 71 |     this.data = PatternSchema.parse(data);
         |                               ^
      72 |   }
      73 |
      74 |   get id(): PatternId {

      at Object.get error [as error] (node_modules/zod/v3/types.cjs:45:31)
      at ZodObject.parse (node_modules/zod/v3/types.cjs:120:22)
      at new PatternModel (aml/models/Pattern.ts:71:31)
      at aml/QueryEngine.ts:329:22
          at Array.map (<anonymous>)
      at QueryEngine.rankPatterns (aml/QueryEngine.ts:328:29)
      at Object.<anonymous> (aml/__tests__/QueryEngine.test.ts:289:29)

  ● QueryEngine › Ranking Algorithms › should rank patterns with target context

    ZodError: [
      {
        "validation": "uuid",
        "code": "invalid_string",
        "message": "Invalid uuid",
        "path": [
          "id"
        ]
      }
    ]

      69 |
      70 |   constructor(data: Pattern) {
    > 71 |     this.data = PatternSchema.parse(data);
         |                               ^
      72 |   }
      73 |
      74 |   get id(): PatternId {

      at Object.get error [as error] (node_modules/zod/v3/types.cjs:45:31)
      at ZodObject.parse (node_modules/zod/v3/types.cjs:120:22)
      at new PatternModel (aml/models/Pattern.ts:71:31)
      at aml/QueryEngine.ts:329:22
          at Array.map (<anonymous>)
      at QueryEngine.rankPatterns (aml/QueryEngine.ts:328:29)
      at Object.<anonymous> (aml/__tests__/QueryEngine.test.ts:309:29)

  ● QueryEngine › Ranking Algorithms › should rank decisions

    ZodError: [
      {
        "validation": "uuid",
        "code": "invalid_string",
        "message": "Invalid uuid",
        "path": [
          "id"
        ]
      }
    ]

      65 |
      66 |   constructor(data: Decision) {
    > 67 |     this.data = DecisionSchema.parse(data);
         |                                ^
      68 |   }
      69 |
      70 |   get id(): DecisionId {

      at Object.get error [as error] (node_modules/zod/v3/types.cjs:45:31)
      at ZodObject.parse (node_modules/zod/v3/types.cjs:120:22)
      at new DecisionModel (aml/models/Decision.ts:67:32)
      at aml/QueryEngine.ts:395:22
          at Array.map (<anonymous>)
      at QueryEngine.rankDecisions (aml/QueryEngine.ts:394:30)
      at Object.<anonymous> (aml/__tests__/QueryEngine.test.ts:331:29)

FAIL aml/__tests__/PruningService.test.ts
  PruningService
    Time-Based Pruning
      ✕ should remove patterns unused for >90 days (11 ms)
      ✕ should remove failed patterns after 30 days (4 ms)
      ✕ should archive old decisions instead of deleting (1 ms)
    Performance-Based Pruning
      ✕ should remove patterns with <20% success rate (5 ms)
      ✕ should prune solutions that no longer apply (4 ms)
      ✕ should keep high-value patterns regardless of age (6 ms)
    Space-Based Pruning
      ✕ should trigger when agent memory >80MB (5 ms)
      ✕ should remove lowest confidence patterns first (2 ms)
      ✕ should compress old data instead of deleting (6 ms)
    Pattern Weighting
      ✕ should calculate pattern weight correctly (5 ms)
      ✕ should weight recent patterns higher (5 ms)
      ✕ should weight high-success patterns higher (2 ms)
    Pruning Reports
      ✕ should generate pruning recommendations (2 ms)
      ✕ should estimate space savings (2 ms)
    Safety Mechanisms
      ✕ should require confirmation for aggressive pruning (2 ms)
      ✕ should create backup before pruning (1 ms)
      ✕ should support dry-run mode (1 ms)

  ● PruningService › Time-Based Pruning › should remove patterns unused for >90 days

    TypeError: memoryStore.ensureAgentDirectory is not a function

      40 |     it('should remove patterns unused for >90 days', async () => {
      41 |       const AGENT = 'test-agent';
    > 42 |       await memoryStore.ensureAgentDirectory(AGENT);
         |                         ^
      43 |
      44 |       // Old unused pattern (95 days ago)
      45 |       const oldDate = new Date();

      at Object.<anonymous> (aml/__tests__/PruningService.test.ts:42:25)

  ● PruningService › Time-Based Pruning › should remove failed patterns after 30 days

    TypeError: memoryStore.ensureAgentDirectory is not a function

      91 |     it('should remove failed patterns after 30 days', async () => {
      92 |       const AGENT = 'test-agent';
    > 93 |       await memoryStore.ensureAgentDirectory(AGENT);
         |                         ^
      94 |
      95 |       const oldFailedDate = new Date();
      96 |       oldFailedDate.setDate(oldFailedDate.getDate() - 35);

      at Object.<anonymous> (aml/__tests__/PruningService.test.ts:93:25)

  ● PruningService › Time-Based Pruning › should archive old decisions instead of deleting

    TypeError: memoryStore.ensureAgentDirectory is not a function

      120 |     it('should archive old decisions instead of deleting', async () => {
      121 |       const AGENT = 'backend-architect';
    > 122 |       await memoryStore.ensureAgentDirectory(AGENT);
          |                         ^
      123 |
      124 |       const oldDecision = {
      125 |         id: 'old-decision',

      at Object.<anonymous> (aml/__tests__/PruningService.test.ts:122:25)

  ● PruningService › Performance-Based Pruning › should remove patterns with <20% success rate

    TypeError: memoryStore.ensureAgentDirectory is not a function

      157 |     it('should remove patterns with <20% success rate', async () => {
      158 |       const AGENT = 'test-agent';
    > 159 |       await memoryStore.ensureAgentDirectory(AGENT);
          |                         ^
      160 |
      161 |       // Low success pattern
      162 |       const lowSuccessPattern: Pattern = {

      at Object.<anonymous> (aml/__tests__/PruningService.test.ts:159:25)

  ● PruningService › Performance-Based Pruning › should prune solutions that no longer apply

    TypeError: memoryStore.ensureAgentDirectory is not a function

      204 |     it('should prune solutions that no longer apply', async () => {
      205 |       const AGENT = 'debugger';
    > 206 |       await memoryStore.ensureAgentDirectory(AGENT);
          |                         ^
      207 |
      208 |       const outdatedSolution = {
      209 |         id: 'outdated',

      at Object.<anonymous> (aml/__tests__/PruningService.test.ts:206:25)

  ● PruningService › Performance-Based Pruning › should keep high-value patterns regardless of age

    TypeError: memoryStore.ensureAgentDirectory is not a function

      240 |     it('should keep high-value patterns regardless of age', async () => {
      241 |       const AGENT = 'test-agent';
    > 242 |       await memoryStore.ensureAgentDirectory(AGENT);
          |                         ^
      243 |
      244 |       const oldDate = new Date();
      245 |       oldDate.setDate(oldDate.getDate() - 100);

      at Object.<anonymous> (aml/__tests__/PruningService.test.ts:242:25)

  ● PruningService › Space-Based Pruning › should trigger when agent memory >80MB

    TypeError: memoryStore.ensureAgentDirectory is not a function

      279 |     it('should trigger when agent memory >80MB', async () => {
      280 |       const AGENT = 'test-agent';
    > 281 |       await memoryStore.ensureAgentDirectory(AGENT);
          |                         ^
      282 |
      283 |       // Create many patterns to simulate high memory usage
      284 |       for (let i = 0; i < 100; i++) {

      at Object.<anonymous> (aml/__tests__/PruningService.test.ts:281:25)

  ● PruningService › Space-Based Pruning › should remove lowest confidence patterns first

    TypeError: memoryStore.ensureAgentDirectory is not a function

      315 |     it('should remove lowest confidence patterns first', async () => {
      316 |       const AGENT = 'test-agent';
    > 317 |       await memoryStore.ensureAgentDirectory(AGENT);
          |                         ^
      318 |
      319 |       // Add patterns with different confidence scores
      320 |       const patterns: Pattern[] = [

      at Object.<anonymous> (aml/__tests__/PruningService.test.ts:317:25)

  ● PruningService › Space-Based Pruning › should compress old data instead of deleting

    TypeError: memoryStore.ensureAgentDirectory is not a function

      377 |     it('should compress old data instead of deleting', async () => {
      378 |       const AGENT = 'test-agent';
    > 379 |       await memoryStore.ensureAgentDirectory(AGENT);
          |                         ^
      380 |
      381 |       const oldPattern: Pattern = {
      382 |         id: 'old',

      at Object.<anonymous> (aml/__tests__/PruningService.test.ts:379:25)

  ● PruningService › Pattern Weighting › should calculate pattern weight correctly

    TypeError: pruningService.calculatePatternWeight is not a function

      418 |       };
      419 |
    > 420 |       const weight = await pruningService.calculatePatternWeight(pattern);
          |                                           ^
      421 |
      422 |       expect(weight).toBeGreaterThan(0);
      423 |       expect(weight).toBeLessThanOrEqual(1);

      at Object.<anonymous> (aml/__tests__/PruningService.test.ts:420:43)

  ● PruningService › Pattern Weighting › should weight recent patterns higher

    TypeError: pruningService.calculatePatternWeight is not a function

      453 |       };
      454 |
    > 455 |       const recentWeight = await pruningService.calculatePatternWeight(recentPattern);
          |                                                 ^
      456 |       const oldWeight = await pruningService.calculatePatternWeight(oldPattern);
      457 |
      458 |       expect(recentWeight).toBeGreaterThan(oldWeight);

      at Object.<anonymous> (aml/__tests__/PruningService.test.ts:455:49)

  ● PruningService › Pattern Weighting › should weight high-success patterns higher

    TypeError: pruningService.calculatePatternWeight is not a function

      488 |       };
      489 |
    > 490 |       const highWeight = await pruningService.calculatePatternWeight(highSuccessPattern);
          |                                               ^
      491 |       const lowWeight = await pruningService.calculatePatternWeight(lowSuccessPattern);
      492 |
      493 |       expect(highWeight).toBeGreaterThan(lowWeight);

      at Object.<anonymous> (aml/__tests__/PruningService.test.ts:490:47)

  ● PruningService › Pruning Reports › should generate pruning recommendations

    TypeError: memoryStore.ensureAgentDirectory is not a function

      498 |     it('should generate pruning recommendations', async () => {
      499 |       const AGENT = 'test-agent';
    > 500 |       await memoryStore.ensureAgentDirectory(AGENT);
          |                         ^
      501 |
      502 |       // Add various patterns
      503 |       for (let i = 0; i < 50; i++) {

      at Object.<anonymous> (aml/__tests__/PruningService.test.ts:500:25)

  ● PruningService › Pruning Reports › should estimate space savings

    TypeError: memoryStore.ensureAgentDirectory is not a function

      530 |     it('should estimate space savings', async () => {
      531 |       const AGENT = 'test-agent';
    > 532 |       await memoryStore.ensureAgentDirectory(AGENT);
          |                         ^
      533 |
      534 |       for (let i = 0; i < 20; i++) {
      535 |         await memoryStore.addPattern(AGENT, {

      at Object.<anonymous> (aml/__tests__/PruningService.test.ts:532:25)

  ● PruningService › Safety Mechanisms › should require confirmation for aggressive pruning

    TypeError: memoryStore.ensureAgentDirectory is not a function

      562 |     it('should require confirmation for aggressive pruning', async () => {
      563 |       const AGENT = 'test-agent';
    > 564 |       await memoryStore.ensureAgentDirectory(AGENT);
          |                         ^
      565 |
      566 |       const result = await pruningService.pruneByPerformance(AGENT, {
      567 |         minSuccessRate: 0.8, // Aggressive threshold

      at Object.<anonymous> (aml/__tests__/PruningService.test.ts:564:25)

  ● PruningService › Safety Mechanisms › should create backup before pruning

    TypeError: memoryStore.ensureAgentDirectory is not a function

      575 |     it('should create backup before pruning', async () => {
      576 |       const AGENT = 'test-agent';
    > 577 |       await memoryStore.ensureAgentDirectory(AGENT);
          |                         ^
      578 |
      579 |       await memoryStore.addPattern(AGENT, {
      580 |         id: 'test',

      at Object.<anonymous> (aml/__tests__/PruningService.test.ts:577:25)

  ● PruningService › Safety Mechanisms › should support dry-run mode

    TypeError: memoryStore.ensureAgentDirectory is not a function

      602 |     it('should support dry-run mode', async () => {
      603 |       const AGENT = 'test-agent';
    > 604 |       await memoryStore.ensureAgentDirectory(AGENT);
          |                         ^
      605 |
      606 |       await memoryStore.addPattern(AGENT, {
      607 |         id: 'test',

      at Object.<anonymous> (aml/__tests__/PruningService.test.ts:604:25)

FAIL aml/__tests__/MemoryService.test.ts
  ● MemoryService › Initialization › should initialize successfully

    Failed to load configuration: EISDIR: illegal operation on a directory, read

      45 |         this.loaded = true;
      46 |       } else {
    > 47 |         throw new Error(`Failed to load configuration: ${(error as Error).message}`);
         |               ^
      48 |       }
      49 |     }
      50 |   }

      at ConfigManager.load (aml/config/ConfigManager.ts:47:15)
      at MemoryService.initialize (aml/MemoryService.ts:133:5)
      at Object.<anonymous> (aml/__tests__/MemoryService.test.ts:34:5)

  ● MemoryService › Initialization › should check if AML is enabled globally

    Failed to load configuration: EISDIR: illegal operation on a directory, read

      45 |         this.loaded = true;
      46 |       } else {
    > 47 |         throw new Error(`Failed to load configuration: ${(error as Error).message}`);
         |               ^
      48 |       }
      49 |     }
      50 |   }

      at ConfigManager.load (aml/config/ConfigManager.ts:47:15)
      at MemoryService.initialize (aml/MemoryService.ts:133:5)
      at Object.<anonymous> (aml/__tests__/MemoryService.test.ts:34:5)

  ● MemoryService › Initialization › should check if AML is enabled for specific agent

    Failed to load configuration: EISDIR: illegal operation on a directory, read

      45 |         this.loaded = true;
      46 |       } else {
    > 47 |         throw new Error(`Failed to load configuration: ${(error as Error).message}`);
         |               ^
      48 |       }
      49 |     }
      50 |   }

      at ConfigManager.load (aml/config/ConfigManager.ts:47:15)
      at MemoryService.initialize (aml/MemoryService.ts:133:5)
      at Object.<anonymous> (aml/__tests__/MemoryService.test.ts:34:5)

  ● MemoryService › Initialization › should return false for disabled agent

    Failed to load configuration: EISDIR: illegal operation on a directory, read

      45 |         this.loaded = true;
      46 |       } else {
    > 47 |         throw new Error(`Failed to load configuration: ${(error as Error).message}`);
         |               ^
      48 |       }
      49 |     }
      50 |   }

      at ConfigManager.load (aml/config/ConfigManager.ts:47:15)
      at MemoryService.initialize (aml/MemoryService.ts:133:5)
      at Object.<anonymous> (aml/__tests__/MemoryService.test.ts:34:5)

  ● MemoryService › Pattern Operations › should record a new pattern

    Failed to load configuration: EISDIR: illegal operation on a directory, read

      45 |         this.loaded = true;
      46 |       } else {
    > 47 |         throw new Error(`Failed to load configuration: ${(error as Error).message}`);
         |               ^
      48 |       }
      49 |     }
      50 |   }

      at ConfigManager.load (aml/config/ConfigManager.ts:47:15)
      at MemoryService.initialize (aml/MemoryService.ts:133:5)
      at Object.<anonymous> (aml/__tests__/MemoryService.test.ts:34:5)

  ● MemoryService › Pattern Operations › should query patterns for agent

    Failed to load configuration: EISDIR: illegal operation on a directory, read

      45 |         this.loaded = true;
      46 |       } else {
    > 47 |         throw new Error(`Failed to load configuration: ${(error as Error).message}`);
         |               ^
      48 |       }
      49 |     }
      50 |   }

      at ConfigManager.load (aml/config/ConfigManager.ts:47:15)
      at MemoryService.initialize (aml/MemoryService.ts:133:5)
      at Object.<anonymous> (aml/__tests__/MemoryService.test.ts:34:5)

  ● MemoryService › Pattern Operations › should filter patterns by type

    Failed to load configuration: EISDIR: illegal operation on a directory, read

      45 |         this.loaded = true;
      46 |       } else {
    > 47 |         throw new Error(`Failed to load configuration: ${(error as Error).message}`);
         |               ^
      48 |       }
      49 |     }
      50 |   }

      at ConfigManager.load (aml/config/ConfigManager.ts:47:15)
      at MemoryService.initialize (aml/MemoryService.ts:133:5)
      at Object.<anonymous> (aml/__tests__/MemoryService.test.ts:34:5)

  ● MemoryService › Pattern Operations › should filter patterns by minimum confidence

    Failed to load configuration: EISDIR: illegal operation on a directory, read

      45 |         this.loaded = true;
      46 |       } else {
    > 47 |         throw new Error(`Failed to load configuration: ${(error as Error).message}`);
         |               ^
      48 |       }
      49 |     }
      50 |   }

      at ConfigManager.load (aml/config/ConfigManager.ts:47:15)
      at MemoryService.initialize (aml/MemoryService.ts:133:5)
      at Object.<anonymous> (aml/__tests__/MemoryService.test.ts:34:5)

  ● MemoryService › Pattern Operations › should sort patterns by weight

    Failed to load configuration: EISDIR: illegal operation on a directory, read

      45 |         this.loaded = true;
      46 |       } else {
    > 47 |         throw new Error(`Failed to load configuration: ${(error as Error).message}`);
         |               ^
      48 |       }
      49 |     }
      50 |   }

      at ConfigManager.load (aml/config/ConfigManager.ts:47:15)
      at MemoryService.initialize (aml/MemoryService.ts:133:5)
      at Object.<anonymous> (aml/__tests__/MemoryService.test.ts:34:5)

  ● MemoryService › Pattern Operations › should limit results by count

    Failed to load configuration: EISDIR: illegal operation on a directory, read

      45 |         this.loaded = true;
      46 |       } else {
    > 47 |         throw new Error(`Failed to load configuration: ${(error as Error).message}`);
         |               ^
      48 |       }
      49 |     }
      50 |   }

      at ConfigManager.load (aml/config/ConfigManager.ts:47:15)
      at MemoryService.initialize (aml/MemoryService.ts:133:5)
      at Object.<anonymous> (aml/__tests__/MemoryService.test.ts:34:5)

  ● MemoryService › Pattern Operations › should retrieve pattern by ID

    Failed to load configuration: EISDIR: illegal operation on a directory, read

      45 |         this.loaded = true;
      46 |       } else {
    > 47 |         throw new Error(`Failed to load configuration: ${(error as Error).message}`);
         |               ^
      48 |       }
      49 |     }
      50 |   }

      at ConfigManager.load (aml/config/ConfigManager.ts:47:15)
      at MemoryService.initialize (aml/MemoryService.ts:133:5)
      at Object.<anonymous> (aml/__tests__/MemoryService.test.ts:34:5)

  ● MemoryService › Pattern Operations › should return null for non-existent pattern

    Failed to load configuration: EISDIR: illegal operation on a directory, read

      45 |         this.loaded = true;
      46 |       } else {
    > 47 |         throw new Error(`Failed to load configuration: ${(error as Error).message}`);
         |               ^
      48 |       }
      49 |     }
      50 |   }

      at ConfigManager.load (aml/config/ConfigManager.ts:47:15)
      at MemoryService.initialize (aml/MemoryService.ts:133:5)
      at Object.<anonymous> (aml/__tests__/MemoryService.test.ts:34:5)

  ● MemoryService › Pattern Operations › should record pattern usage and update metrics

    Failed to load configuration: EISDIR: illegal operation on a directory, read

      45 |         this.loaded = true;
      46 |       } else {
    > 47 |         throw new Error(`Failed to load configuration: ${(error as Error).message}`);
         |               ^
      48 |       }
      49 |     }
      50 |   }

      at ConfigManager.load (aml/config/ConfigManager.ts:47:15)
      at MemoryService.initialize (aml/MemoryService.ts:133:5)
      at Object.<anonymous> (aml/__tests__/MemoryService.test.ts:34:5)

  ● MemoryService › Pattern Operations › should handle failed pattern usage

    Failed to load configuration: EISDIR: illegal operation on a directory, read

      45 |         this.loaded = true;
      46 |       } else {
    > 47 |         throw new Error(`Failed to load configuration: ${(error as Error).message}`);
         |               ^
      48 |       }
      49 |     }
      50 |   }

      at ConfigManager.load (aml/config/ConfigManager.ts:47:15)
      at MemoryService.initialize (aml/MemoryService.ts:133:5)
      at Object.<anonymous> (aml/__tests__/MemoryService.test.ts:34:5)

  ● MemoryService › Pattern Operations › should handle empty pattern queries gracefully

    Failed to load configuration: EISDIR: illegal operation on a directory, read

      45 |         this.loaded = true;
      46 |       } else {
    > 47 |         throw new Error(`Failed to load configuration: ${(error as Error).message}`);
         |               ^
      48 |       }
      49 |     }
      50 |   }

      at ConfigManager.load (aml/config/ConfigManager.ts:47:15)
      at MemoryService.initialize (aml/MemoryService.ts:133:5)
      at Object.<anonymous> (aml/__tests__/MemoryService.test.ts:34:5)

  ● MemoryService › Pattern Operations › should enforce pattern count limits

    Failed to load configuration: EISDIR: illegal operation on a directory, read

      45 |         this.loaded = true;
      46 |       } else {
    > 47 |         throw new Error(`Failed to load configuration: ${(error as Error).message}`);
         |               ^
      48 |       }
      49 |     }
      50 |   }

      at ConfigManager.load (aml/config/ConfigManager.ts:47:15)
      at MemoryService.initialize (aml/MemoryService.ts:133:5)
      at Object.<anonymous> (aml/__tests__/MemoryService.test.ts:34:5)

  ● MemoryService › Solution Operations › should record a new solution

    Failed to load configuration: EISDIR: illegal operation on a directory, read

      45 |         this.loaded = true;
      46 |       } else {
    > 47 |         throw new Error(`Failed to load configuration: ${(error as Error).message}`);
         |               ^
      48 |       }
      49 |     }
      50 |   }

      at ConfigManager.load (aml/config/ConfigManager.ts:47:15)
      at MemoryService.initialize (aml/MemoryService.ts:133:5)
      at Object.<anonymous> (aml/__tests__/MemoryService.test.ts:34:5)

  ● MemoryService › Solution Operations › should query solutions by error type

    Failed to load configuration: EISDIR: illegal operation on a directory, read

      45 |         this.loaded = true;
      46 |       } else {
    > 47 |         throw new Error(`Failed to load configuration: ${(error as Error).message}`);
         |               ^
      48 |       }
      49 |     }
      50 |   }

      at ConfigManager.load (aml/config/ConfigManager.ts:47:15)
      at MemoryService.initialize (aml/MemoryService.ts:133:5)
      at Object.<anonymous> (aml/__tests__/MemoryService.test.ts:34:5)

  ● MemoryService › Solution Operations › should query solutions by error message pattern

    Failed to load configuration: EISDIR: illegal operation on a directory, read

      45 |         this.loaded = true;
      46 |       } else {
    > 47 |         throw new Error(`Failed to load configuration: ${(error as Error).message}`);
         |               ^
      48 |       }
      49 |     }
      50 |   }

      at ConfigManager.load (aml/config/ConfigManager.ts:47:15)
      at MemoryService.initialize (aml/MemoryService.ts:133:5)
      at Object.<anonymous> (aml/__tests__/MemoryService.test.ts:34:5)

  ● MemoryService › Solution Operations › should handle failed solutions

    Failed to load configuration: EISDIR: illegal operation on a directory, read

      45 |         this.loaded = true;
      46 |       } else {
    > 47 |         throw new Error(`Failed to load configuration: ${(error as Error).message}`);
         |               ^
      48 |       }
      49 |     }
      50 |   }

      at ConfigManager.load (aml/config/ConfigManager.ts:47:15)
      at MemoryService.initialize (aml/MemoryService.ts:133:5)
      at Object.<anonymous> (aml/__tests__/MemoryService.test.ts:34:5)

  ● MemoryService › Solution Operations › should enforce solution count limits

    Failed to load configuration: EISDIR: illegal operation on a directory, read

      45 |         this.loaded = true;
      46 |       } else {
    > 47 |         throw new Error(`Failed to load configuration: ${(error as Error).message}`);
         |               ^
      48 |       }
      49 |     }
      50 |   }

      at ConfigManager.load (aml/config/ConfigManager.ts:47:15)
      at MemoryService.initialize (aml/MemoryService.ts:133:5)
      at Object.<anonymous> (aml/__tests__/MemoryService.test.ts:34:5)

  ● MemoryService › Decision Operations › should record a new decision

    Failed to load configuration: EISDIR: illegal operation on a directory, read

      45 |         this.loaded = true;
      46 |       } else {
    > 47 |         throw new Error(`Failed to load configuration: ${(error as Error).message}`);
         |               ^
      48 |       }
      49 |     }
      50 |   }

      at ConfigManager.load (aml/config/ConfigManager.ts:47:15)
      at MemoryService.initialize (aml/MemoryService.ts:133:5)
      at Object.<anonymous> (aml/__tests__/MemoryService.test.ts:34:5)

  ● MemoryService › Decision Operations › should query decisions by type

    Failed to load configuration: EISDIR: illegal operation on a directory, read

      45 |         this.loaded = true;
      46 |       } else {
    > 47 |         throw new Error(`Failed to load configuration: ${(error as Error).message}`);
         |               ^
      48 |       }
      49 |     }
      50 |   }

      at ConfigManager.load (aml/config/ConfigManager.ts:47:15)
      at MemoryService.initialize (aml/MemoryService.ts:133:5)
      at Object.<anonymous> (aml/__tests__/MemoryService.test.ts:34:5)

  ● MemoryService › Decision Operations › should filter decisions by outcome presence

    Failed to load configuration: EISDIR: illegal operation on a directory, read

      45 |         this.loaded = true;
      46 |       } else {
    > 47 |         throw new Error(`Failed to load configuration: ${(error as Error).message}`);
         |               ^
      48 |       }
      49 |     }
      50 |   }

      at ConfigManager.load (aml/config/ConfigManager.ts:47:15)
      at MemoryService.initialize (aml/MemoryService.ts:133:5)
      at Object.<anonymous> (aml/__tests__/MemoryService.test.ts:34:5)

  ● MemoryService › Metrics Operations › should get metrics report for agent

    Failed to load configuration: EISDIR: illegal operation on a directory, read

      45 |         this.loaded = true;
      46 |       } else {
    > 47 |         throw new Error(`Failed to load configuration: ${(error as Error).message}`);
         |               ^
      48 |       }
      49 |     }
      50 |   }

      at ConfigManager.load (aml/config/ConfigManager.ts:47:15)
      at MemoryService.initialize (aml/MemoryService.ts:133:5)
      at Object.<anonymous> (aml/__tests__/MemoryService.test.ts:34:5)

  ● MemoryService › Metrics Operations › should calculate health score correctly

    Failed to load configuration: EISDIR: illegal operation on a directory, read

      45 |         this.loaded = true;
      46 |       } else {
    > 47 |         throw new Error(`Failed to load configuration: ${(error as Error).message}`);
         |               ^
      48 |       }
      49 |     }
      50 |   }

      at ConfigManager.load (aml/config/ConfigManager.ts:47:15)
      at MemoryService.initialize (aml/MemoryService.ts:133:5)
      at Object.<anonymous> (aml/__tests__/MemoryService.test.ts:34:5)

  ● MemoryService › Metrics Operations › should get metrics for all agents

    Failed to load configuration: EISDIR: illegal operation on a directory, read

      45 |         this.loaded = true;
      46 |       } else {
    > 47 |         throw new Error(`Failed to load configuration: ${(error as Error).message}`);
         |               ^
      48 |       }
      49 |     }
      50 |   }

      at ConfigManager.load (aml/config/ConfigManager.ts:47:15)
      at MemoryService.initialize (aml/MemoryService.ts:133:5)
      at Object.<anonymous> (aml/__tests__/MemoryService.test.ts:34:5)

  ● MemoryService › Metrics Operations › should return null for disabled agent metrics

    Failed to load configuration: EISDIR: illegal operation on a directory, read

      45 |         this.loaded = true;
      46 |       } else {
    > 47 |         throw new Error(`Failed to load configuration: ${(error as Error).message}`);
         |               ^
      48 |       }
      49 |     }
      50 |   }

      at ConfigManager.load (aml/config/ConfigManager.ts:47:15)
      at MemoryService.initialize (aml/MemoryService.ts:133:5)
      at Object.<anonymous> (aml/__tests__/MemoryService.test.ts:34:5)

  ● MemoryService › Memory Management › should list all agents with memory

    Failed to load configuration: EISDIR: illegal operation on a directory, read

      45 |         this.loaded = true;
      46 |       } else {
    > 47 |         throw new Error(`Failed to load configuration: ${(error as Error).message}`);
         |               ^
      48 |       }
      49 |     }
      50 |   }

      at ConfigManager.load (aml/config/ConfigManager.ts:47:15)
      at MemoryService.initialize (aml/MemoryService.ts:133:5)
      at Object.<anonymous> (aml/__tests__/MemoryService.test.ts:34:5)

  ● MemoryService › Memory Management › should get total memory usage

    Failed to load configuration: EISDIR: illegal operation on a directory, read

      45 |         this.loaded = true;
      46 |       } else {
    > 47 |         throw new Error(`Failed to load configuration: ${(error as Error).message}`);
         |               ^
      48 |       }
      49 |     }
      50 |   }

      at ConfigManager.load (aml/config/ConfigManager.ts:47:15)
      at MemoryService.initialize (aml/MemoryService.ts:133:5)
      at Object.<anonymous> (aml/__tests__/MemoryService.test.ts:34:5)

  ● MemoryService › Memory Management › should export agent memory

    Failed to load configuration: EISDIR: illegal operation on a directory, read

      45 |         this.loaded = true;
      46 |       } else {
    > 47 |         throw new Error(`Failed to load configuration: ${(error as Error).message}`);
         |               ^
      48 |       }
      49 |     }
      50 |   }

      at ConfigManager.load (aml/config/ConfigManager.ts:47:15)
      at MemoryService.initialize (aml/MemoryService.ts:133:5)
      at Object.<anonymous> (aml/__tests__/MemoryService.test.ts:34:5)

  ● MemoryService › Memory Management › should import agent memory

    Failed to load configuration: EISDIR: illegal operation on a directory, read

      45 |         this.loaded = true;
      46 |       } else {
    > 47 |         throw new Error(`Failed to load configuration: ${(error as Error).message}`);
         |               ^
      48 |       }
      49 |     }
      50 |   }

      at ConfigManager.load (aml/config/ConfigManager.ts:47:15)
      at MemoryService.initialize (aml/MemoryService.ts:133:5)
      at Object.<anonymous> (aml/__tests__/MemoryService.test.ts:34:5)

  ● MemoryService › Memory Management › should clear agent memory with backup

    Failed to load configuration: EISDIR: illegal operation on a directory, read

      45 |         this.loaded = true;
      46 |       } else {
    > 47 |         throw new Error(`Failed to load configuration: ${(error as Error).message}`);
         |               ^
      48 |       }
      49 |     }
      50 |   }

      at ConfigManager.load (aml/config/ConfigManager.ts:47:15)
      at MemoryService.initialize (aml/MemoryService.ts:133:5)
      at Object.<anonymous> (aml/__tests__/MemoryService.test.ts:34:5)

  ● MemoryService › Memory Management › should clear agent memory without backup

    Failed to load configuration: EISDIR: illegal operation on a directory, read

      45 |         this.loaded = true;
      46 |       } else {
    > 47 |         throw new Error(`Failed to load configuration: ${(error as Error).message}`);
         |               ^
      48 |       }
      49 |     }
      50 |   }

      at ConfigManager.load (aml/config/ConfigManager.ts:47:15)
      at MemoryService.initialize (aml/MemoryService.ts:133:5)
      at Object.<anonymous> (aml/__tests__/MemoryService.test.ts:34:5)

  ● MemoryService › Caching Behavior › should use cache for repeated queries

    Failed to load configuration: EISDIR: illegal operation on a directory, read

      45 |         this.loaded = true;
      46 |       } else {
    > 47 |         throw new Error(`Failed to load configuration: ${(error as Error).message}`);
         |               ^
      48 |       }
      49 |     }
      50 |   }

      at ConfigManager.load (aml/config/ConfigManager.ts:47:15)
      at MemoryService.initialize (aml/MemoryService.ts:133:5)
      at Object.<anonymous> (aml/__tests__/MemoryService.test.ts:34:5)

  ● MemoryService › Error Handling › should handle AML disabled gracefully

    Failed to load configuration: EISDIR: illegal operation on a directory, read

      45 |         this.loaded = true;
      46 |       } else {
    > 47 |         throw new Error(`Failed to load configuration: ${(error as Error).message}`);
         |               ^
      48 |       }
      49 |     }
      50 |   }

      at ConfigManager.load (aml/config/ConfigManager.ts:47:15)
      at MemoryService.initialize (aml/MemoryService.ts:133:5)
      at Object.<anonymous> (aml/__tests__/MemoryService.test.ts:34:5)

  ● MemoryService › Error Handling › should handle invalid pattern usage

    Failed to load configuration: EISDIR: illegal operation on a directory, read

      45 |         this.loaded = true;
      46 |       } else {
    > 47 |         throw new Error(`Failed to load configuration: ${(error as Error).message}`);
         |               ^
      48 |       }
      49 |     }
      50 |   }

      at ConfigManager.load (aml/config/ConfigManager.ts:47:15)
      at MemoryService.initialize (aml/MemoryService.ts:133:5)
      at Object.<anonymous> (aml/__tests__/MemoryService.test.ts:34:5)

  ● MemoryService › Error Handling › should validate context matching

    Failed to load configuration: EISDIR: illegal operation on a directory, read

      45 |         this.loaded = true;
      46 |       } else {
    > 47 |         throw new Error(`Failed to load configuration: ${(error as Error).message}`);
         |               ^
      48 |       }
      49 |     }
      50 |   }

      at ConfigManager.load (aml/config/ConfigManager.ts:47:15)
      at MemoryService.initialize (aml/MemoryService.ts:133:5)
      at Object.<anonymous> (aml/__tests__/MemoryService.test.ts:34:5)

  ● MemoryService › Performance Requirements › should query patterns in <50ms

    Failed to load configuration: EISDIR: illegal operation on a directory, read

      45 |         this.loaded = true;
      46 |       } else {
    > 47 |         throw new Error(`Failed to load configuration: ${(error as Error).message}`);
         |               ^
      48 |       }
      49 |     }
      50 |   }

      at ConfigManager.load (aml/config/ConfigManager.ts:47:15)
      at MemoryService.initialize (aml/MemoryService.ts:133:5)
      at Object.<anonymous> (aml/__tests__/MemoryService.test.ts:34:5)

  ● MemoryService › Performance Requirements › should record pattern in <100ms

    Failed to load configuration: EISDIR: illegal operation on a directory, read

      45 |         this.loaded = true;
      46 |       } else {
    > 47 |         throw new Error(`Failed to load configuration: ${(error as Error).message}`);
         |               ^
      48 |       }
      49 |     }
      50 |   }

      at ConfigManager.load (aml/config/ConfigManager.ts:47:15)
      at MemoryService.initialize (aml/MemoryService.ts:133:5)
      at Object.<anonymous> (aml/__tests__/MemoryService.test.ts:34:5)


  ● Test suite failed to run

    Failed to save configuration: EISDIR: illegal operation on a directory, open '/Users/maxfahl/Fahl/Common/Loom/.loom-framework/test-memory'

      62 |       await fs.writeFile(this.configPath, JSON.stringify(this.config, null, 2), 'utf-8');
      63 |     } catch (error) {
    > 64 |       throw new Error(`Failed to save configuration: ${(error as Error).message}`);
         |             ^
      65 |     }
      66 |   }
      67 |

      at ConfigManager.save (aml/config/ConfigManager.ts:64:13)
      at ConfigManager.updateConfig (aml/config/ConfigManager.ts:83:5)

PASS aml/__tests__/CacheLayer.test.ts
  CacheLayer
    Basic Operations
      ✓ should set and get values (8 ms)
      ✓ should return null for non-existent key (5 ms)
      ✓ should check key existence without updating access (10 ms)
      ✓ should delete keys (1 ms)
      ✓ should not delete non-existent keys (1 ms)
      ✓ should clear entire cache
      ✓ should get all keys (1 ms)
      ✓ should return cache size
    TTL & Expiration
      ✓ should expire entries after TTL (152 ms)
      ✓ should manually evict expired entries (152 ms)
      ✓ should not expire entries within TTL
      ✓ should reset TTL on update (127 ms)
    LRU Eviction Policy
      ✓ should evict least recently used item at capacity
      ✓ should update access order on get
    LFU Eviction Policy
      ✓ should evict least frequently used item at capacity
    Statistics
      ✓ should track cache hits
      ✓ should track cache misses (1 ms)
      ✓ should calculate hit rate
      ✓ should track evictions
      ✓ should reset statistics
      ✓ should report current size in stats
    Configuration
      ✓ should update cache options
      ✓ should evict items when reducing maxSize
      ✓ should update TTL
      ✓ should switch eviction policy
    Edge Cases
      ✓ should handle empty cache operations (1 ms)
      ✓ should handle single-item cache
      ✓ should handle duplicate key updates
      ✓ should handle null/undefined values
      ✓ should handle object values
    Performance
      ✓ should perform set operations quickly (3 ms)
      ✓ should perform get operations quickly (6 ms)
      ✓ should maintain high hit rate with LRU (2 ms)
  AMLCacheManager
    ✓ should initialize with separate caches (1 ms)
    ✓ should clear all caches
    ✓ should evict expired entries from all caches (152 ms)
    ✓ should combine statistics from all caches (1 ms)
    ✓ should warm cache with preloaded data (1 ms)
    ✓ should allocate cache sizes proportionally

FAIL aml/__tests__/security/encryption.test.ts
  EnhancedEncryption
    Basic Encryption/Decryption
      ✓ should encrypt and decrypt data correctly (82 ms)
      ✓ should encrypt objects correctly (38 ms)
      ✓ should generate different ciphertexts for same plaintext (61 ms)
      ✓ should include correct metadata (50 ms)
    HMAC Integrity Verification
      ✓ should detect tampering via HMAC (67 ms)
      ✓ should detect tampering via auth tag (35 ms)
      ✓ should detect IV modification (51 ms)
    Context-Based Key Separation
      ✓ should use different keys for different contexts (57 ms)
      ✓ should fail to decrypt with wrong context (58 ms)
      ✓ should work without context (36 ms)
    Key Rotation
      ✓ should rotate master key (144 ms)
      ✓ should clear key cache after rotation (129 ms)
    Backward Compatibility
      ✓ should decrypt legacy v1 format (29 ms)
    Performance Benchmarks
      ✕ should encrypt 10KB in <5ms (44 ms)
      ✓ should decrypt 10KB in <5ms (36 ms)
      ✓ should cache derived keys (71 ms)
    Security Test Vectors
      ✓ should use cryptographically secure random values (70 ms)
      ✓ should use correct key lengths (43 ms)
      ✓ should not leak plaintext in error messages (37 ms)
    Edge Cases
      ✓ should handle empty strings (38 ms)
      ✓ should handle large data (55 ms)
      ✓ should handle special characters (44 ms)
      ✓ should handle unicode correctly (39 ms)
    Memory Management
      ✕ should clear master key on demand (96 ms)
      ✓ should clear key cache (52 ms)

  ● EnhancedEncryption › Performance Benchmarks › should encrypt 10KB in <5ms

    expect(received).toBeLessThan(expected)

    Expected: < 10
    Received:   12

      227 |
      228 |       console.log(`Encryption time for 10KB: ${duration}ms`);
    > 229 |       expect(duration).toBeLessThan(10); // Lenient for CI environments
          |                        ^
      230 |     });
      231 |
      232 |     it('should decrypt 10KB in <5ms', async () => {

      at Object.<anonymous> (aml/__tests__/security/encryption.test.ts:229:24)

  ● EnhancedEncryption › Memory Management › should clear master key on demand

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: "test"

      364 |
      365 |       // Should need to reinitialize
    > 366 |       await expect(encryption.decrypt(encrypted)).rejects.toThrow();
          |                   ^
      367 |     });
      368 |
      369 |     it('should clear key cache', async () => {

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (aml/__tests__/security/encryption.test.ts:366:19)

Test Suites: 5 failed, 2 passed, 7 total
Tests:       87 failed, 117 passed, 204 total
Snapshots:   0 total
Time:        3.081 s
Ran all test suites matching /aml\/__tests__/i.

```

---

### ✅ ACP Integration Tests

**Status**: passed

---

### ❌ Framework Integration Tests

**Status**: failed

**Error**:
```
Command failed: npm run test:integration
ts-jest[ts-jest-transformer] (WARN) Define `ts-jest` config under `globals` is deprecated. Please do
transform: {
    <transform_regex>: ['ts-jest', { /* ts-jest config goes here in Jest */ }],
},
See more at https://kulshekhar.github.io/ts-jest/docs/getting-started/presets#advanced
FAIL tests/integration/framework-integration.test.ts
  Loom Framework Integration
    Project Setup (Loomify)
      ✓ should create complete Loom project structure (71 ms)
      ✓ should have valid status.xml structure (53 ms)
      ✓ should have CLAUDE.md with framework markers (32 ms)
      ✓ should detect existing vs new project (30 ms)
    Feature Creation
      ✓ should create new feature (epic) successfully (30 ms)
      ✓ should update status.xml with new epic (31 ms)
      ✓ should prevent duplicate epic names (30 ms)
      ✓ should validate epic name format (29 ms)
    Story Creation
      ✓ should create story under current epic (33 ms)
      ✓ should update status.xml with current story (34 ms)
      ✓ should store stories in correct epic directory (45 ms)
      ✓ should fail if no epic is set (32 ms)
    Development Workflow
      ✓ should have current story set before development (31 ms)
      ✓ should create source files during development (33 ms)
      ✓ should track file changes during development (32 ms)
    YOLO Mode
      ✓ should toggle YOLO mode (34 ms)
      ✓ should affect agent behavior in YOLO mode (35 ms)
    Cross-Reference Validation
      ✓ should validate status.xml schema (56 ms)
      ✓ should validate CLAUDE.md markers (32 ms)
      ✕ should validate epic references in stories (33 ms)
    Error Recovery
      ✓ should handle corrupted status.xml (34 ms)
      ✓ should handle missing status.xml (31 ms)
      ✓ should recover from partial setup (36 ms)
    Concurrency Handling
      ✓ should handle multiple rapid story creations (37 ms)
      ✓ should detect concurrent status.xml updates (47 ms)
    Migration and Upgrade
      ✓ should detect framework version (34 ms)
      ✓ should support story migration between epics (36 ms)

  ● Loom Framework Integration › Cross-Reference Validation › should validate epic references in stories

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      284 |       const epicFile = path.join(epicDir, 'EPIC.md');
      285 |
    > 286 |       expect(fs.existsSync(epicFile)).toBe(true);
          |                                       ^
      287 |     });
      288 |   });
      289 |

      at Object.<anonymous> (tests/integration/framework-integration.test.ts:286:39)

Test Suites: 1 failed, 1 total
Tests:       1 failed, 26 passed, 27 total
Snapshots:   0 total
Time:        1.481 s, estimated 2 s
Ran all test suites matching /tests\/integration/i.

```

---

### ❌ End-to-End Tests

**Status**: failed

**Error**:
```
Command failed: npm run test:e2e
ts-jest[ts-jest-transformer] (WARN) Define `ts-jest` config under `globals` is deprecated. Please do
transform: {
    <transform_regex>: ['ts-jest', { /* ts-jest config goes here in Jest */ }],
},
See more at https://kulshekhar.github.io/ts-jest/docs/getting-started/presets#advanced
FAIL tests/e2e/complete-workflow.test.ts
  E2E: Complete Development Workflow
    ✓ E2E: New Project Setup -> Feature -> Story -> Dev -> Commit (13 ms)
    ✓ E2E: Multiple stories in single epic (3 ms)
    ✕ E2E: Switch between multiple epics (5 ms)
  E2E: Error Scenarios
    ✓ E2E: Create story without epic should fail (4 ms)
    ✕ E2E: Corrupted status.xml recovery
  E2E: Performance Tests
    ✓ E2E: Create 10 epics quickly (5 ms)
    ✓ E2E: Create 50 stories quickly (7 ms)
    ✕ E2E: Rapid status.xml updates (1 ms)

  ● E2E: Complete Development Workflow › E2E: Switch between multiple epics

    ENOENT: no such file or directory, open '/Users/maxfahl/Fahl/Common/Loom/.loom-framework/.test-temp/e2e-workflow-test/status.xml'

      124 |   ): void {
      125 |     const statusPath = path.join(projectDir, 'status.xml');
    > 126 |     let content = fs.readFileSync(statusPath, 'utf-8');
          |                      ^
      127 |
      128 |     if (updates.epic) {
      129 |       content = content.replace(

      at TestHelper.updateStatusXml (tests/utils/test-helpers.ts:126:22)
      at Object.<anonymous> (tests/e2e/complete-workflow.test.ts:144:16)

  ● E2E: Error Scenarios › E2E: Corrupted status.xml recovery

    ENOENT: no such file or directory, open '/Users/maxfahl/Fahl/Common/Loom/.loom-framework/.test-temp/e2e-error-test/status.xml'

      203 |     // Corrupt status.xml
      204 |     const statusPath = path.join(projectDir, 'status.xml');
    > 205 |     const backup = fs.readFileSync(statusPath, 'utf-8');
          |                       ^
      206 |
      207 |     fs.writeFileSync(statusPath, 'corrupted');
      208 |

      at Object.<anonymous> (tests/e2e/complete-workflow.test.ts:205:23)

  ● E2E: Performance Tests › E2E: Rapid status.xml updates

    ENOENT: no such file or directory, open '/Users/maxfahl/Fahl/Common/Loom/.loom-framework/.test-temp/e2e-performance-test/status.xml'

      124 |   ): void {
      125 |     const statusPath = path.join(projectDir, 'status.xml');
    > 126 |     let content = fs.readFileSync(statusPath, 'utf-8');
          |                      ^
      127 |
      128 |     if (updates.epic) {
      129 |       content = content.replace(

      at TestHelper.updateStatusXml (tests/utils/test-helpers.ts:126:22)
      at Object.<anonymous> (tests/e2e/complete-workflow.test.ts:288:18)

Test Suites: 1 failed, 1 total
Tests:       3 failed, 5 passed, 8 total
Snapshots:   0 total
Time:        0.754 s, estimated 1 s
Ran all test suites matching /tests\/e2e/i.

```

---
