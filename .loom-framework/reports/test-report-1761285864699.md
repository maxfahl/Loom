# Loom Framework Test Report

**Generated**: 2025-10-24T06:04:24.698Z
**Duration**: 9.20s
**Total Suites**: 4
**Passed**: 2
**Failed**: 2

## Test Suites

### ❌ Unit Tests

**Status**: failed

**Error**:
```
Command failed: npm run test:unit --  --passWithNoTests
ts-jest[ts-jest-transformer] (WARN) Define `ts-jest` config under `globals` is deprecated. Please do
transform: {
    <transform_regex>: ['ts-jest', { /* ts-jest config goes here in Jest */ }],
},
See more at https://kulshekhar.github.io/ts-jest/docs/getting-started/presets#advanced
ts-jest[ts-jest-transformer] (WARN) Define `ts-jest` config under `globals` is deprecated. Please do
transform: {
    <transform_regex>: ['ts-jest', { /* ts-jest config goes here in Jest */ }],
},
See more at https://kulshekhar.github.io/ts-jest/docs/getting-started/presets#advanced
ts-jest[ts-jest-transformer] (WARN) Define `ts-jest` config under `globals` is deprecated. Please do
transform: {
    <transform_regex>: ['ts-jest', { /* ts-jest config goes here in Jest */ }],
},
See more at https://kulshekhar.github.io/ts-jest/docs/getting-started/presets#advanced
ts-jest[ts-jest-transformer] (WARN) Define `ts-jest` config under `globals` is deprecated. Please do
transform: {
    <transform_regex>: ['ts-jest', { /* ts-jest config goes here in Jest */ }],
},
See more at https://kulshekhar.github.io/ts-jest/docs/getting-started/presets#advanced
ts-jest[ts-jest-transformer] (WARN) Define `ts-jest` config under `globals` is deprecated. Please do
transform: {
    <transform_regex>: ['ts-jest', { /* ts-jest config goes here in Jest */ }],
},
See more at https://kulshekhar.github.io/ts-jest/docs/getting-started/presets#advanced
ts-jest[ts-jest-transformer] (WARN) Define `ts-jest` config under `globals` is deprecated. Please do
transform: {
    <transform_regex>: ['ts-jest', { /* ts-jest config goes here in Jest */ }],
},
See more at https://kulshekhar.github.io/ts-jest/docs/getting-started/presets#advanced
ts-jest[ts-jest-transformer] (WARN) Define `ts-jest` config under `globals` is deprecated. Please do
transform: {
    <transform_regex>: ['ts-jest', { /* ts-jest config goes here in Jest */ }],
},
See more at https://kulshekhar.github.io/ts-jest/docs/getting-started/presets#advanced
PASS aml/__tests__/security/access-control.test.ts
  AccessControl
    Role-Based Permissions
      ✓ should allow admin all operations (8 ms)
      ✓ should allow developer read/write but not admin operations (1 ms)
      ✓ should allow read-only only read operations (1 ms)
    Agent Isolation
      ✓ should prevent agents from accessing other agents' data
      ✓ should allow agents to access their own data (1 ms)
      ✓ should allow admin to access any agent data
    Project Isolation
      ✓ should prevent access across projects (1 ms)
      ✓ should allow access within same project
      ✓ should allow admin to access any project (1 ms)
    Resource Ownership
      ✓ should prevent non-owners from deleting resources
      ✓ should allow owners to delete their resources
      ✓ should allow admin to delete any resource (1 ms)
    Require Access (Throws)
      ✓ should throw AccessDeniedError when access denied (16 ms)
      ✓ should not throw when access allowed (1 ms)
    Role Hierarchy
      ✓ should recognize admin as higher than developer
      ✓ should recognize developer as higher than read-only (1 ms)
      ✓ should recognize read-only as lowest role
    Permission Checks
      ✓ should check if user can perform ANY operation (1 ms)
      ✓ should check if user can perform ALL operations
    Encryption Context Generation
      ✓ should generate deterministic project context (1 ms)
      ✓ should generate deterministic agent context (1 ms)
    Role Permissions
      ✓ should return all permissions for a role (1 ms)
    Principal Creation
      ✓ should create principal from parameters
      ✓ should parse role strings correctly (1 ms)
      ✓ should default to developer for unknown roles
      ✓ should use environment variables as fallback (1 ms)

PASS aml/__tests__/QueryEngine.test.ts
  QueryEngine
    Index Management
      ✓ should build pattern index (6 ms)
      ✓ should index patterns by type
      ✓ should index patterns by tags (1 ms)
      ✓ should index patterns by context
      ✓ should index patterns by confidence buckets (1 ms)
      ✓ should build solution index
      ✓ should clear indices
      ✓ should clear agent-specific indices
    Pattern Search
      ✓ should search patterns by type using index (1 ms)
      ✓ should handle non-existent agent in search
      ✓ should search patterns by single context key-value
      ✓ should search patterns by multiple context keys (intersection) (1 ms)
    Similarity Calculation
      ✓ should calculate exact pattern similarity
      ✓ should calculate different pattern similarity
      ✓ should find similar patterns with threshold (1 ms)
      ✓ should exclude self from similarity results (1 ms)
      ✓ should respect similarity threshold (1 ms)
      ✓ should respect limit on results (1 ms)
    Ranking Algorithms
      ✓ should rank patterns by confidence (7 ms)
      ✓ should rank patterns by recency (4 ms)
      ✓ should rank patterns by usage frequency (2 ms)
      ✓ should rank patterns with target context (2 ms)
      ✓ should rank solutions (2 ms)
      ✓ should rank decisions (8 ms)
    Fuzzy Search
      ✓ should fuzzy search patterns by query (10 ms)
      ✓ should find exact substring matches first (4 ms)
      ✓ should fuzzy search solutions by error message (3 ms)
      ✓ should handle case-insensitive fuzzy search
      ✓ should respect minimum similarity threshold in fuzzy search (5 ms)
    Analytics
      ✓ should calculate pattern statistics (2 ms)
      ✓ should identify top pattern types (1 ms)
      ✓ should handle empty pattern list in statistics (1 ms)
    Edge Cases & Performance
      ✓ should handle large pattern sets (7 ms)
      ✓ should handle empty context matching (1 ms)
      ✓ should handle patterns with no tags
      ✓ should handle similarity calculation with different feature spaces (6 ms)

PASS aml/__tests__/MemoryService.test.ts
  MemoryService
    Initialization
      ✓ should initialize successfully (21 ms)
      ✓ should check if AML is enabled globally (3 ms)
      ✓ should check if AML is enabled for specific agent (2 ms)
      ✓ should return false for disabled agent (5 ms)
    Pattern Operations
      ✓ should record a new pattern (25 ms)
      ✓ should query patterns for agent (23 ms)
      ✓ should filter patterns by type (1 ms)
      ✓ should filter patterns by minimum confidence (1 ms)
      ✓ should sort patterns by weight (1 ms)
      ✓ should limit results by count (1 ms)
      ✓ should retrieve pattern by ID (9 ms)
      ✓ should return null for non-existent pattern
      ✓ should record pattern usage and update metrics (9 ms)
      ✓ should handle failed pattern usage (14 ms)
      ✓ should handle empty pattern queries gracefully (1 ms)
      ✓ should enforce pattern count limits (82 ms)
    Solution Operations
      ✓ should record a new solution (5 ms)
      ✓ should query solutions by error type (7 ms)
      ✓ should query solutions by error message pattern
      ✓ should handle failed solutions (4 ms)
      ✓ should enforce solution count limits (1 ms)
    Decision Operations
      ✓ should record a new decision (4 ms)
      ✓ should query decisions by type (5 ms)
      ✓ should filter decisions by outcome presence
    Metrics Operations
      ✓ should get metrics report for agent (2 ms)
      ✓ should calculate health score correctly (2 ms)
      ✓ should get metrics for all agents (1 ms)
      ✓ should return null for disabled agent metrics
    Memory Management
      ✓ should list all agents with memory (1 ms)
      ✓ should get total memory usage
      ✓ should export agent memory (11 ms)
      ✓ should import agent memory (9 ms)
      ✓ should clear agent memory with backup (1 ms)
      ✓ should clear agent memory without backup
    Caching Behavior
      ✓ should use cache for repeated queries
    Error Handling
      ✓ should handle AML disabled gracefully (2 ms)
      ✓ should handle invalid pattern usage
      ✓ should validate context matching (6 ms)
    Performance Requirements
      ✓ should query patterns in <50ms (1 ms)
      ✓ should record pattern in <100ms (5 ms)

PASS aml/__tests__/CacheLayer.test.ts
  CacheLayer
    Basic Operations
      ✓ should set and get values (2 ms)
      ✓ should return null for non-existent key
      ✓ should check key existence without updating access
      ✓ should delete keys (1 ms)
      ✓ should not delete non-existent keys (1 ms)
      ✓ should clear entire cache
      ✓ should get all keys (1 ms)
      ✓ should return cache size
    TTL & Expiration
      ✓ should expire entries after TTL (152 ms)
      ✓ should manually evict expired entries (151 ms)
      ✓ should not expire entries within TTL
      ✓ should reset TTL on update (127 ms)
    LRU Eviction Policy
      ✓ should evict least recently used item at capacity (1 ms)
      ✓ should update access order on get
    LFU Eviction Policy
      ✓ should evict least frequently used item at capacity (1 ms)
    Statistics
      ✓ should track cache hits
      ✓ should track cache misses
      ✓ should calculate hit rate
      ✓ should track evictions
      ✓ should reset statistics
      ✓ should report current size in stats (1 ms)
    Configuration
      ✓ should update cache options
      ✓ should evict items when reducing maxSize
      ✓ should update TTL
      ✓ should switch eviction policy
    Edge Cases
      ✓ should handle empty cache operations (1 ms)
      ✓ should handle single-item cache (1 ms)
      ✓ should handle duplicate key updates
      ✓ should handle null/undefined values
      ✓ should handle object values
    Performance
      ✓ should perform set operations quickly (3 ms)
      ✓ should perform get operations quickly (4 ms)
      ✓ should maintain high hit rate with LRU (1 ms)
  AMLCacheManager
    ✓ should initialize with separate caches (1 ms)
    ✓ should clear all caches
    ✓ should evict expired entries from all caches (150 ms)
    ✓ should combine statistics from all caches (1 ms)
    ✓ should warm cache with preloaded data
    ✓ should allocate cache sizes proportionally

FAIL aml/__tests__/PruningService.test.ts
  PruningService
    Time-Based Pruning
      ✕ should remove patterns unused for >90 days (40 ms)
      ✕ should remove failed patterns after 30 days (19 ms)
      ✕ should archive old decisions instead of deleting (15 ms)
    Performance-Based Pruning
      ✕ should remove patterns with <20% success rate (25 ms)
      ✕ should prune solutions that no longer apply (19 ms)
      ✕ should keep high-value patterns regardless of age (13 ms)
    Space-Based Pruning
      ✕ should trigger when agent memory >80MB (788 ms)
      ✕ should remove lowest confidence patterns first (13 ms)
      ✕ should compress old data instead of deleting (6 ms)
    Pattern Weighting
      ✕ should calculate pattern weight correctly (1 ms)
      ✕ should weight recent patterns higher (2 ms)
      ✕ should weight high-success patterns higher (2 ms)
    Pruning Reports
      ✕ should generate pruning recommendations (246 ms)
      ✕ should estimate space savings (98 ms)
    Safety Mechanisms
      ✕ should require confirmation for aggressive pruning (6 ms)
      ✕ should create backup before pruning (8 ms)
      ✕ should support dry-run mode (10 ms)

  ● PruningService › Time-Based Pruning › should remove patterns unused for >90 days

    TypeError: pruningService.pruneByTime is not a function

      78 |       await memoryStore.addPattern(AGENT, recentPattern);
      79 |
    > 80 |       const result = await pruningService.pruneByTime(AGENT, { maxAgeDays: 90 });
         |                                           ^
      81 |
      82 |       expect(result.success).toBe(true);
      83 |       expect(result.data?.removedCount).toBe(1);

      at Object.<anonymous> (aml/__tests__/PruningService.test.ts:80:43)

  ● PruningService › Time-Based Pruning › should remove failed patterns after 30 days

    TypeError: pruningService.pruneFailedPatterns is not a function

      112 |       await memoryStore.addPattern(AGENT, oldFailedPattern);
      113 |
    > 114 |       const result = await pruningService.pruneFailedPatterns(AGENT, { minAgeDays: 30, maxSuccessRate: 0.2 });
          |                                           ^
      115 |
      116 |       expect(result.success).toBe(true);
      117 |       expect(result.data?.removedCount).toBe(1);

      at Object.<anonymous> (aml/__tests__/PruningService.test.ts:114:43)

  ● PruningService › Time-Based Pruning › should archive old decisions instead of deleting

    TypeError: pruningService.archiveOldDecisions is not a function

      143 |       await memoryStore.addDecision(AGENT, oldDecision);
      144 |
    > 145 |       const result = await pruningService.archiveOldDecisions(AGENT, { maxAgeDays: 180 });
          |                                           ^
      146 |
      147 |       expect(result.success).toBe(true);
      148 |       expect(result.data?.archivedCount).toBe(1);

      at Object.<anonymous> (aml/__tests__/PruningService.test.ts:145:43)

  ● PruningService › Performance-Based Pruning › should remove patterns with <20% success rate

    TypeError: pruningService.pruneByPerformance is not a function

      192 |       await memoryStore.addPattern(AGENT, highSuccessPattern);
      193 |
    > 194 |       const result = await pruningService.pruneByPerformance(AGENT, { minSuccessRate: 0.2 });
          |                                           ^
      195 |
      196 |       expect(result.success).toBe(true);
      197 |       expect(result.data?.removedCount).toBe(1);

      at Object.<anonymous> (aml/__tests__/PruningService.test.ts:194:43)

  ● PruningService › Performance-Based Pruning › should prune solutions that no longer apply

    TypeError: pruningService.pruneOutdatedSolutions is not a function

      232 |       await memoryStore.addSolution(AGENT, outdatedSolution);
      233 |
    > 234 |       const result = await pruningService.pruneOutdatedSolutions(AGENT);
          |                                           ^
      235 |
      236 |       expect(result.success).toBe(true);
      237 |       expect(result.data?.removedCount).toBeGreaterThanOrEqual(0);

      at Object.<anonymous> (aml/__tests__/PruningService.test.ts:234:43)

  ● PruningService › Performance-Based Pruning › should keep high-value patterns regardless of age

    TypeError: pruningService.pruneByTime is not a function

      262 |       await memoryStore.addPattern(AGENT, highValuePattern);
      263 |
    > 264 |       const result = await pruningService.pruneByTime(AGENT, {
          |                                           ^
      265 |         maxAgeDays: 90,
      266 |         preserveHighValue: true,
      267 |         minConfidenceToPreserve: 0.9

      at Object.<anonymous> (aml/__tests__/PruningService.test.ts:264:43)

  ● PruningService › Space-Based Pruning › should trigger when agent memory >80MB

    TypeError: pruningService.checkMemorySize is not a function

      298 |       }
      299 |
    > 300 |       const sizeCheck = await pruningService.checkMemorySize(AGENT);
          |                                              ^
      301 |       const shouldPrune = sizeCheck.data!.sizeMB > 80;
      302 |
      303 |       if (shouldPrune) {

      at Object.<anonymous> (aml/__tests__/PruningService.test.ts:300:46)

  ● PruningService › Space-Based Pruning › should remove lowest confidence patterns first

    TypeError: pruningService.pruneBySpace is not a function

      365 |
      366 |       // Prune 1 pattern
    > 367 |       const result = await pruningService.pruneBySpace(AGENT, { removeCount: 1 });
          |                                           ^
      368 |
      369 |       expect(result.success).toBe(true);
      370 |

      at Object.<anonymous> (aml/__tests__/PruningService.test.ts:367:43)

  ● PruningService › Space-Based Pruning › should compress old data instead of deleting

    TypeError: pruningService.compressOldData is not a function

      395 |       await memoryStore.addPattern(AGENT, oldPattern);
      396 |
    > 397 |       const result = await pruningService.compressOldData(AGENT, { maxAgeDays: 60 });
          |                                           ^
      398 |
      399 |       expect(result.success).toBe(true);
      400 |       expect(result.data).toHaveProperty('compressionRatio');

      at Object.<anonymous> (aml/__tests__/PruningService.test.ts:397:43)

  ● PruningService › Pattern Weighting › should calculate pattern weight correctly

    TypeError: pruningService.calculatePatternWeight is not a function

      418 |       };
      419 |
    > 420 |       const weight = await pruningService.calculatePatternWeight(pattern);
          |                                           ^
      421 |
      422 |       expect(weight).toBeGreaterThan(0);
      423 |       expect(weight).toBeLessThanOrEqual(1);

      at Object.<anonymous> (aml/__tests__/PruningService.test.ts:420:43)

  ● PruningService › Pattern Weighting › should weight recent patterns higher

    TypeError: pruningService.calculatePatternWeight is not a function

      453 |       };
      454 |
    > 455 |       const recentWeight = await pruningService.calculatePatternWeight(recentPattern);
          |                                                 ^
      456 |       const oldWeight = await pruningService.calculatePatternWeight(oldPattern);
      457 |
      458 |       expect(recentWeight).toBeGreaterThan(oldWeight);

      at Object.<anonymous> (aml/__tests__/PruningService.test.ts:455:49)

  ● PruningService › Pattern Weighting › should weight high-success patterns higher

    TypeError: pruningService.calculatePatternWeight is not a function

      488 |       };
      489 |
    > 490 |       const highWeight = await pruningService.calculatePatternWeight(highSuccessPattern);
          |                                               ^
      491 |       const lowWeight = await pruningService.calculatePatternWeight(lowSuccessPattern);
      492 |
      493 |       expect(highWeight).toBeGreaterThan(lowWeight);

      at Object.<anonymous> (aml/__tests__/PruningService.test.ts:490:47)

  ● PruningService › Pruning Reports › should generate pruning recommendations

    TypeError: pruningService.generatePruningReport is not a function

      520 |       }
      521 |
    > 522 |       const report = await pruningService.generatePruningReport(AGENT);
          |                                           ^
      523 |
      524 |       expect(report.success).toBe(true);
      525 |       expect(report.data).toHaveProperty('totalPatterns');

      at Object.<anonymous> (aml/__tests__/PruningService.test.ts:522:43)

  ● PruningService › Pruning Reports › should estimate space savings

    TypeError: pruningService.estimateSpaceSavings is not a function

      548 |       }
      549 |
    > 550 |       const estimate = await pruningService.estimateSpaceSavings(AGENT, {
          |                                             ^
      551 |         minSuccessRate: 0.5
      552 |       });
      553 |

      at Object.<anonymous> (aml/__tests__/PruningService.test.ts:550:45)

  ● PruningService › Safety Mechanisms › should require confirmation for aggressive pruning

    TypeError: pruningService.pruneByPerformance is not a function

      564 |       await memoryStore.ensureAgentDirectory(AGENT);
      565 |
    > 566 |       const result = await pruningService.pruneByPerformance(AGENT, {
          |                                           ^
      567 |         minSuccessRate: 0.8, // Aggressive threshold
      568 |         requireConfirmation: true
      569 |       });

      at Object.<anonymous> (aml/__tests__/PruningService.test.ts:566:43)

  ● PruningService › Safety Mechanisms › should create backup before pruning

    TypeError: pruningService.pruneByPerformance is not a function

      591 |       });
      592 |
    > 593 |       const result = await pruningService.pruneByPerformance(AGENT, {
          |                                           ^
      594 |         minSuccessRate: 0.7,
      595 |         createBackup: true
      596 |       });

      at Object.<anonymous> (aml/__tests__/PruningService.test.ts:593:43)

  ● PruningService › Safety Mechanisms › should support dry-run mode

    TypeError: pruningService.pruneByPerformance is not a function

      618 |       });
      619 |
    > 620 |       const result = await pruningService.pruneByPerformance(AGENT, {
          |                                           ^
      621 |         minSuccessRate: 0.5,
      622 |         dryRun: true
      623 |       });

      at Object.<anonymous> (aml/__tests__/PruningService.test.ts:620:43)

FAIL aml/__tests__/security/encryption.test.ts
  EnhancedEncryption
    Basic Encryption/Decryption
      ✓ should encrypt and decrypt data correctly (58 ms)
      ✓ should encrypt objects correctly (52 ms)
      ✓ should generate different ciphertexts for same plaintext (70 ms)
      ✓ should include correct metadata (47 ms)
    HMAC Integrity Verification
      ✓ should detect tampering via HMAC (60 ms)
      ✓ should detect tampering via auth tag (44 ms)
      ✓ should detect IV modification (40 ms)
    Context-Based Key Separation
      ✓ should use different keys for different contexts (58 ms)
      ✓ should fail to decrypt with wrong context (56 ms)
      ✓ should work without context (40 ms)
    Key Rotation
      ✓ should rotate master key (131 ms)
      ✓ should clear key cache after rotation (156 ms)
    Backward Compatibility
      ✓ should decrypt legacy v1 format (30 ms)
    Performance Benchmarks
      ✕ should encrypt 10KB in <5ms (38 ms)
      ✓ should decrypt 10KB in <5ms (39 ms)
      ✓ should cache derived keys (53 ms)
    Security Test Vectors
      ✓ should use cryptographically secure random values (49 ms)
      ✓ should use correct key lengths (38 ms)
      ✓ should not leak plaintext in error messages (41 ms)
    Edge Cases
      ✓ should handle empty strings (35 ms)
      ✓ should handle large data (43 ms)
      ✓ should handle special characters (39 ms)
      ✓ should handle unicode correctly (37 ms)
    Memory Management
      ✕ should clear master key on demand (77 ms)
      ✓ should clear key cache (52 ms)

  ● EnhancedEncryption › Performance Benchmarks › should encrypt 10KB in <5ms

    expect(received).toBeLessThan(expected)

    Expected: < 10
    Received:   14

      227 |
      228 |       console.log(`Encryption time for 10KB: ${duration}ms`);
    > 229 |       expect(duration).toBeLessThan(10); // Lenient for CI environments
          |                        ^
      230 |     });
      231 |
      232 |     it('should decrypt 10KB in <5ms', async () => {

      at Object.<anonymous> (aml/__tests__/security/encryption.test.ts:229:24)

  ● EnhancedEncryption › Memory Management › should clear master key on demand

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: "test"

      364 |
      365 |       // Should need to reinitialize
    > 366 |       await expect(encryption.decrypt(encrypted)).rejects.toThrow();
          |                   ^
      367 |     });
      368 |
      369 |     it('should clear key cache', async () => {

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (aml/__tests__/security/encryption.test.ts:366:19)

FAIL aml/__tests__/BackupManager.test.ts
  BackupManager
    Full Backup
      ✕ should create full backup (36 ms)
      ✕ should include all agent directories in backup (21 ms)
      ✕ should include global data in backup (6 ms)
      ✕ should create compressed backup file (716 ms)
    Incremental Backup
      ✕ should create incremental backup after full backup (6 ms)
      ✕ should be smaller than full backup (235 ms)
    Backup Validation
      ✕ should validate backup integrity (5 ms)
      ✕ should detect corrupted backup (3 ms)
      ✕ should validate backup contents (11 ms)
    Restore Operations
      ✕ should restore from full backup (11 ms)
      ✕ should restore to point in time (9 ms)
      ✕ should create backup before restore (6 ms)
    Backup Cleanup
      ✕ should list all backups (3 ms)
      ✕ should delete old backups (5 ms)
      ✕ should keep last N backups (4 ms)
      ✕ should delete specific backup (4 ms)
    Performance
      ✕ should handle large backup efficiently (3157 ms)
      ✕ should restore quickly (335 ms)
    Error Handling
      ✕ should handle missing backup file (1 ms)
      ✕ should handle corrupted backup during restore (10 ms)
      ✕ should handle disk space issues gracefully (3 ms)

  ● BackupManager › Full Backup › should create full backup

    TypeError: backupManager.createFullBackup is not a function

      58 |       });
      59 |
    > 60 |       const result = await backupManager.createFullBackup();
         |                                          ^
      61 |
      62 |       expect(result.success).toBe(true);
      63 |       expect(result.data).toHaveProperty('backupId');

      at Object.<anonymous> (aml/__tests__/BackupManager.test.ts:60:42)

  ● BackupManager › Full Backup › should include all agent directories in backup

    TypeError: backupManager.createFullBackup is not a function

      72 |       await memoryStore.ensureAgentDirectory('agent-3');
      73 |
    > 74 |       const result = await backupManager.createFullBackup();
         |                                          ^
      75 |
      76 |       expect(result.success).toBe(true);
      77 |

      at Object.<anonymous> (aml/__tests__/BackupManager.test.ts:74:42)

  ● BackupManager › Full Backup › should include global data in backup

    TypeError: memoryStore.setGlobalData is not a function

      82 |
      83 |     it('should include global data in backup', async () => {
    > 84 |       await memoryStore.setGlobalData('test-key', { value: 'test' });
         |                         ^
      85 |
      86 |       const result = await backupManager.createFullBackup();
      87 |

      at Object.<anonymous> (aml/__tests__/BackupManager.test.ts:84:25)

  ● BackupManager › Full Backup › should create compressed backup file

    TypeError: backupManager.createFullBackup is not a function

      109 |       }
      110 |
    > 111 |       const result = await backupManager.createFullBackup();
          |                                          ^
      112 |
      113 |       expect(result.success).toBe(true);
      114 |       expect(result.data?.compressed).toBe(true);

      at Object.<anonymous> (aml/__tests__/BackupManager.test.ts:111:42)

  ● BackupManager › Incremental Backup › should create incremental backup after full backup

    TypeError: backupManager.createFullBackup is not a function

      120 |       // Create full backup
      121 |       await memoryStore.ensureAgentDirectory('agent-1');
    > 122 |       const fullBackup = await backupManager.createFullBackup();
          |                                              ^
      123 |
      124 |       // Add more data
      125 |       await memoryStore.addPattern('agent-1', {

      at Object.<anonymous> (aml/__tests__/BackupManager.test.ts:122:46)

  ● BackupManager › Incremental Backup › should be smaller than full backup

    TypeError: backupManager.createFullBackup is not a function

      164 |       }
      165 |
    > 166 |       const fullBackup = await backupManager.createFullBackup();
          |                                              ^
      167 |
      168 |       // Add a few more patterns
      169 |       for (let i = 50; i < 55; i++) {

      at Object.<anonymous> (aml/__tests__/BackupManager.test.ts:166:46)

  ● BackupManager › Backup Validation › should validate backup integrity

    TypeError: backupManager.createFullBackup is not a function

      192 |     it('should validate backup integrity', async () => {
      193 |       await memoryStore.ensureAgentDirectory('agent-1');
    > 194 |       const backup = await backupManager.createFullBackup();
          |                                          ^
      195 |
      196 |       const validation = await backupManager.validateBackup(backup.data!.backupId);
      197 |

      at Object.<anonymous> (aml/__tests__/BackupManager.test.ts:194:42)

  ● BackupManager › Backup Validation › should detect corrupted backup

    TypeError: backupManager.createFullBackup is not a function

      203 |     it('should detect corrupted backup', async () => {
      204 |       await memoryStore.ensureAgentDirectory('agent-1');
    > 205 |       const backup = await backupManager.createFullBackup();
          |                                          ^
      206 |
      207 |       // Corrupt the backup file
      208 |       const backupPath = path.join(BACKUP_DIR, `${backup.data!.backupId}.tar.gz`);

      at Object.<anonymous> (aml/__tests__/BackupManager.test.ts:205:42)

  ● BackupManager › Backup Validation › should validate backup contents

    TypeError: backupManager.createFullBackup is not a function

      231 |       });
      232 |
    > 233 |       const backup = await backupManager.createFullBackup();
          |                                          ^
      234 |       const validation = await backupManager.validateBackup(backup.data!.backupId);
      235 |
      236 |       expect(validation.data?.fileCount).toBeGreaterThan(0);

      at Object.<anonymous> (aml/__tests__/BackupManager.test.ts:233:42)

  ● BackupManager › Restore Operations › should restore from full backup

    TypeError: backupManager.createFullBackup is not a function

      258 |
      259 |       // Create backup
    > 260 |       const backup = await backupManager.createFullBackup();
          |                                          ^
      261 |
      262 |       // Delete data
      263 |       await fs.rm(path.join(MEMORY_DIR, 'agent-1'), { recursive: true });

      at Object.<anonymous> (aml/__tests__/BackupManager.test.ts:260:42)

  ● BackupManager › Restore Operations › should restore to point in time

    TypeError: backupManager.createFullBackup is not a function

      292 |         evolution: { created: new Date().toISOString(), lastUsed: new Date().toISOString(), refinements: 0, confidenceScore: 0.6 }
      293 |       });
    > 294 |       const backup1 = await backupManager.createFullBackup();
          |                                           ^
      295 |       const timestamp1 = backup1.data!.timestamp;
      296 |
      297 |       await new Promise(resolve => setTimeout(resolve, 100));

      at Object.<anonymous> (aml/__tests__/BackupManager.test.ts:294:43)

  ● BackupManager › Restore Operations › should create backup before restore

    TypeError: backupManager.createFullBackup is not a function

      323 |     it('should create backup before restore', async () => {
      324 |       await memoryStore.ensureAgentDirectory('agent-1');
    > 325 |       const originalBackup = await backupManager.createFullBackup();
          |                                                  ^
      326 |
      327 |       // Modify data
      328 |       await memoryStore.addPattern('agent-1', {

      at Object.<anonymous> (aml/__tests__/BackupManager.test.ts:325:50)

  ● BackupManager › Backup Cleanup › should list all backups

    TypeError: backupManager.createFullBackup is not a function

      361 |       await memoryStore.ensureAgentDirectory('agent-1');
      362 |
    > 363 |       await backupManager.createFullBackup();
          |                           ^
      364 |       await backupManager.createFullBackup();
      365 |       await backupManager.createFullBackup();
      366 |

      at Object.<anonymous> (aml/__tests__/BackupManager.test.ts:363:27)

  ● BackupManager › Backup Cleanup › should delete old backups

    TypeError: backupManager.createFullBackup is not a function

      375 |
      376 |       // Create multiple backups
    > 377 |       const backup1 = await backupManager.createFullBackup();
          |                                           ^
      378 |       await new Promise(resolve => setTimeout(resolve, 100));
      379 |       const backup2 = await backupManager.createFullBackup();
      380 |       await new Promise(resolve => setTimeout(resolve, 100));

      at Object.<anonymous> (aml/__tests__/BackupManager.test.ts:377:43)

  ● BackupManager › Backup Cleanup › should keep last N backups

    TypeError: backupManager.createFullBackup is not a function

      400 |       // Create 10 backups
      401 |       for (let i = 0; i < 10; i++) {
    > 402 |         await backupManager.createFullBackup();
          |                             ^
      403 |         await new Promise(resolve => setTimeout(resolve, 50));
      404 |       }
      405 |

      at Object.<anonymous> (aml/__tests__/BackupManager.test.ts:402:29)

  ● BackupManager › Backup Cleanup › should delete specific backup

    TypeError: backupManager.createFullBackup is not a function

      417 |       await memoryStore.ensureAgentDirectory('agent-1');
      418 |
    > 419 |       const backup = await backupManager.createFullBackup();
          |                                          ^
      420 |
      421 |       const deleteResult = await backupManager.deleteBackup(backup.data!.backupId);
      422 |

      at Object.<anonymous> (aml/__tests__/BackupManager.test.ts:419:42)

  ● BackupManager › Performance › should handle large backup efficiently

    TypeError: backupManager.createFullBackup is not a function

      449 |
      450 |       const start = Date.now();
    > 451 |       const backup = await backupManager.createFullBackup();
          |                                          ^
      452 |       const duration = Date.now() - start;
      453 |
      454 |       expect(backup.success).toBe(true);

      at Object.<anonymous> (aml/__tests__/BackupManager.test.ts:451:42)

  ● BackupManager › Performance › should restore quickly

    TypeError: backupManager.createFullBackup is not a function

      475 |       }
      476 |
    > 477 |       const backup = await backupManager.createFullBackup();
          |                                          ^
      478 |       await fs.rm(path.join(MEMORY_DIR, 'agent-1'), { recursive: true });
      479 |
      480 |       const start = Date.now();

      at Object.<anonymous> (aml/__tests__/BackupManager.test.ts:477:42)

  ● BackupManager › Error Handling › should handle missing backup file

    TypeError: backupManager.restore is not a function

      489 |   describe('Error Handling', () => {
      490 |     it('should handle missing backup file', async () => {
    > 491 |       const restoreResult = await backupManager.restore('nonexistent-backup-id');
          |                                                 ^
      492 |
      493 |       expect(restoreResult.success).toBe(false);
      494 |       expect(restoreResult.error).toContain('not found');

      at Object.<anonymous> (aml/__tests__/BackupManager.test.ts:491:49)

  ● BackupManager › Error Handling › should handle corrupted backup during restore

    TypeError: backupManager.createFullBackup is not a function

      497 |     it('should handle corrupted backup during restore', async () => {
      498 |       await memoryStore.ensureAgentDirectory('agent-1');
    > 499 |       const backup = await backupManager.createFullBackup();
          |                                          ^
      500 |
      501 |       // Corrupt backup
      502 |       const backupPath = path.join(BACKUP_DIR, `${backup.data!.backupId}.tar.gz`);

      at Object.<anonymous> (aml/__tests__/BackupManager.test.ts:499:42)

  ● BackupManager › Error Handling › should handle disk space issues gracefully

    expect(received).toHaveProperty(path)

    Expected path: "createFullBackup"
    Received path: []

    Received value: {"backupPath": "/Users/maxfahl/Fahl/Common/Loom/.loom-framework/aml/__test_data__/backup-manager/backups", "backups": Map {}, "schedule": null, "store": {"storage": {"basePath": "/Users/maxfahl/Fahl/Common/Loom/.loom-framework/aml/__test_data__/backup-manager/memory", "options": {"compression": true, "encoding": "utf-8", "lockRetries": 5, "lockTimeout": 5000}}}}

      511 |       // This is difficult to test without actually filling disk
      512 |       // We'll just verify error handling structure exists
    > 513 |       expect(backupManager).toHaveProperty('createFullBackup');
          |                             ^
      514 |     });
      515 |   });
      516 | });

      at Object.<anonymous> (aml/__tests__/BackupManager.test.ts:513:29)

Test Suites: 3 failed, 4 passed, 7 total
Tests:       40 failed, 164 passed, 204 total
Snapshots:   0 total
Time:        5.571 s, estimated 8 s
Ran all test suites matching /aml\/__tests__/i.

```

---

### ✅ ACP Integration Tests

**Status**: passed

---

### ❌ Framework Integration Tests

**Status**: failed

**Error**:
```
Command failed: npm run test:integration
ts-jest[ts-jest-transformer] (WARN) Define `ts-jest` config under `globals` is deprecated. Please do
transform: {
    <transform_regex>: ['ts-jest', { /* ts-jest config goes here in Jest */ }],
},
See more at https://kulshekhar.github.io/ts-jest/docs/getting-started/presets#advanced
FAIL tests/integration/framework-integration.test.ts
  Loom Framework Integration
    Project Setup (Loomify)
      ✓ should create complete Loom project structure (48 ms)
      ✓ should have valid status.xml structure (34 ms)
      ✓ should have CLAUDE.md with framework markers (36 ms)
      ✓ should detect existing vs new project (34 ms)
    Feature Creation
      ✓ should create new feature (epic) successfully (35 ms)
      ✓ should update status.xml with new epic (33 ms)
      ✓ should prevent duplicate epic names (31 ms)
      ✓ should validate epic name format (31 ms)
    Story Creation
      ✓ should create story under current epic (32 ms)
      ✓ should update status.xml with current story (33 ms)
      ✓ should store stories in correct epic directory (31 ms)
      ✓ should fail if no epic is set (32 ms)
    Development Workflow
      ✓ should have current story set before development (37 ms)
      ✓ should create source files during development (35 ms)
      ✓ should track file changes during development (37 ms)
    YOLO Mode
      ✓ should toggle YOLO mode (38 ms)
      ✓ should affect agent behavior in YOLO mode (33 ms)
    Cross-Reference Validation
      ✓ should validate status.xml schema (35 ms)
      ✓ should validate CLAUDE.md markers (32 ms)
      ✕ should validate epic references in stories (35 ms)
    Error Recovery
      ✓ should handle corrupted status.xml (34 ms)
      ✓ should handle missing status.xml (33 ms)
      ✓ should recover from partial setup (33 ms)
    Concurrency Handling
      ✓ should handle multiple rapid story creations (36 ms)
      ✓ should detect concurrent status.xml updates (36 ms)
    Migration and Upgrade
      ✓ should detect framework version (35 ms)
      ✓ should support story migration between epics (40 ms)

  ● Loom Framework Integration › Cross-Reference Validation › should validate epic references in stories

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      284 |       const epicFile = path.join(epicDir, 'EPIC.md');
      285 |
    > 286 |       expect(fs.existsSync(epicFile)).toBe(true);
          |                                       ^
      287 |     });
      288 |   });
      289 |

      at Object.<anonymous> (tests/integration/framework-integration.test.ts:286:39)

Test Suites: 1 failed, 1 total
Tests:       1 failed, 26 passed, 27 total
Snapshots:   0 total
Time:        1.225 s, estimated 2 s
Ran all test suites matching /tests\/integration/i.

```

---

### ✅ End-to-End Tests

**Status**: passed

---
