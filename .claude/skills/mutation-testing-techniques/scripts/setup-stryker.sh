#!/bin/bash

# setup-stryker.sh
# Description: Initializes Stryker Mutator in a TypeScript project.
# This script installs necessary npm packages and creates a basic stryker.conf.json.

# Usage: ./setup-stryker.sh [project_root]
#   project_root: Optional. The root directory of your TypeScript project. Defaults to current directory.

# --- Configuration Options ---
# You can customize the default test runner and framework here.
DEFAULT_TEST_RUNNER="jest"
DEFAULT_MUTATOR_FRAMEWORK="typescript"

# --- Functions ---
log_info() {
  echo "\033[0;34m[INFO]\033[0m $1"
}

log_success() {
  echo "\033[0;32m[SUCCESS]\033[0m $1"
}

log_error() {
  echo "\033[0;31m[ERROR]\033[0m $1"
  exit 1
}

# --- Main Script ---
PROJECT_ROOT=${1:-$(pwd)}

if [ ! -d "$PROJECT_ROOT" ]; then
  log_error "Project root directory '$PROJECT_ROOT' does not exist."
fi

cd "$PROJECT_ROOT" || log_error "Failed to change to project root directory '$PROJECT_ROOT'."

log_info "Initializing Stryker Mutator in '$PROJECT_ROOT'...\n"

# Check for package.json
if [ ! -f "package.json" ]; then
  log_error "package.json not found in '$PROJECT_ROOT'. Please ensure this is an npm/yarn project."
fi

log_info "Installing Stryker Mutator and dependencies..."

# Install Stryker and its plugins
# Using npm for consistency, can be adapted for yarn/pnpm
npm install --save-dev \
  @stryker-mutator/core \
  @stryker-mutator/jest-runner \
  @stryker-mutator/typescript-checker \
  @stryker-mutator/html-reporter \
  @stryker-mutator/dashboard-reporter || log_error "Failed to install Stryker dependencies."

log_info "Creating basic stryker.conf.json..."

# Generate a basic stryker.conf.json
cat << EOF > stryker.conf.json
{
  "_comment": "Stryker configuration generated by setup-stryker.sh",
  "mutate": [
    "src/**/*.ts",
    "!src/**/*.d.ts",
    "!src/**/*.spec.ts",
    "!src/**/*.test.ts"
  ],
  "testRunner": "$DEFAULT_TEST_RUNNER",
  "mutator": {
    "plugins": [
      "$DEFAULT_MUTATOR_FRAMEWORK"
    ]
  },
  "reporters": [
    "html",
    "clear-text",
    "progress",
    "dashboard"
  ],
  "coverageAnalysis": "perTest",
  "jest": {
    "projectType": "custom",
    "config": {
      "testEnvironment": "node",
      "roots": [
        "<rootDir>/test",
        "<rootDir>/src"
      ],
      "transform": {
        "^.+\\.(ts|tsx)$": "ts-jest"
      }
    }
  },
  "thresholds": {
    "break": 80,
    "high": 90,
    "low": 60
  }
}
EOF

log_success "Stryker Mutator setup complete!"
log_info "A basic 'stryker.conf.json' has been created. Please review and customize it."
log_info "You can now run mutation tests using: npx stryker run"
log_info "For more information, visit: https://stryker-mutator.io/"
